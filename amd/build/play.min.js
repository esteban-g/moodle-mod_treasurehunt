define ("mod_treasurehunt/play",["jquery","core/url","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/osm-geocoder","mod_treasurehunt/viewgpx","core/str","mod_treasurehunt/webqr","mod_treasurehunt/jquery.truncate"],function(a,b,c,d,e,f,g,h){return{playtreasurehunt:function playtreasurehunt(a,b,c,d,e,f,h,j,k,l){var m=["stageovercome","failedlocation","stage","stagename","stageclue","question","noanswerselected","timeexceeded","searching","continue","noattempts","aerialview","roadview","noresults","startfromhere","nomarks","updates","activitytoendwarning","huntcompleted","discoveredlocation","answerwarning","error"],n=m.map(function(a){return{key:a,component:"treasurehunt"}});g.get_strings(n).done(function(g){for(var n=[],o=0;o<m.length;o++){n[m[o]]=g[o]}if("undefined"!=typeof l&&l&&l.custombackgroundurl){var p=new Image;p.addEventListener("load",function(){l.imgwidth=this.naturalWidth;l.imgheight=this.naturalHeight;i(n,a,b,c,d,e,f,h,j,k,l)});p.src=l.custombackgroundurl}else{i(n,a,b,c,d,e,f,h,j,k,l)}})}};function i(g,i,j,k,l,m,n,o,p,q,r){H(!0);var K=null,L=!0,M=15,N="ontouchstart"in window||navigator.msMaxTouchPoints;if(r){if(r.custombackgroundurl){var Pa=c.proj.transformExtent(r.bbox,"EPSG:4326","EPSG:3857");if(!r.geographic){var O=Pa[3]-Pa[1],P=(Pa[2]+Pa[0])/2,Q=(Pa[3]+Pa[1])/2,R=Math.round(O/r.imgheight),S=Math.round(r.imgwidth*R),T=Math.round(r.imgheight*R);Pa=[P-S/2,Q-T/2,P+S/2,Q+T/2];M=5}K=new c.layer.Image({title:r.layername,name:r.layername,type:r.layertype,source:new c.source.ImageStatic({url:r.custombackgroundurl,imageExtent:Pa}),opacity:1})}else if(r.wmsurl){var Qa={source:new c.source.TileWMS({url:r.wmsurl,params:r.wmsparams}),type:r.layertype,title:r.layername,name:r.layername};if(r.bbox[0]&&r.bbox[1]&&r.bbox[2]&&r.bbox[3]){var Ra=c.proj.transformExtent(r.bbox,"EPSG:4326","EPSG:3857");Qa.extent=Ra}K=new c.layer.Tile(Qa)}L=r.geographic}if(!1===L){k=!0;a("#autolocate").hide()}var U=b.imageUrl("success_mark","treasurehunt"),V=b.imageUrl("failure_mark","treasurehunt"),W=b.imageUrl("my_location","treasurehunt"),X={},Y,Z=[],$=[],_=!1,aa=!1,ba=!1,ca=!1,da=!1,ea=!0,fa=!1,ga,ha=0,ia=new c.style.Text({textAlign:"center",scale:1.3,fill:new c.style.Fill({color:"#ffffff"}),stroke:new c.style.Stroke({color:"#000000",width:3.5})}),ja=new c.style.Text({textAlign:"center",scale:1.4,fill:new c.style.Fill({color:"#fff"}),stroke:new c.style.Stroke({color:"#0097a7",width:3.5})}),ka=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:U}),text:ia,zIndex:"Infinity"}),la=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:V}),text:ia,zIndex:"Infinity"}),ma=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:U}),text:ja,zIndex:"Infinity"}),na=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:V}),text:ja,zIndex:"Infinity"}),oa=new c.style.Style({image:new c.style.Circle({radius:6,fill:new c.style.Fill({color:[0,0,0,1]}),stroke:new c.style.Stroke({color:[255,255,255,1],width:2})})}),pa=new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.3]}),stroke:new c.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),qa=new c.style.Style({image:new c.style.Icon({anchor:[.5,.9],opacity:1,scale:1,src:W})}),ra=[],sa=new c.format.GeoJSON,ta=new c.source.Vector({projection:"EPSG:3857"}),ua=new c.layer.Vector({source:ta,style:function(a){var b=a.get("stageposition");if(0===b){var d=new c.style.Fill({color:"rgba(0,0,0,0.1)"}),e=new c.style.Stroke({color:"#0097a7",width:2}),f=new c.style.Style({image:new c.style.Circle({fill:d,stroke:e,radius:5}),fill:d,stroke:e,text:new c.style.Text({text:g.startfromhere,textAlign:"center",fill:new c.style.Fill({color:"rgb(255,255,255)"}),stroke:new c.style.Stroke({color:"#0097a7",width:5})})});return[f]}if(!a.get("geometrysolved")){la.getText().setText(""+b);return[la]}ka.getText().setText(""+b);return[ka]}}),va=new c.layer.Tile({visible:!1,source:new c.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})});va.set("name",g.aerialview);var wa=new c.layer.Tile({source:new c.source.OSM});wa.set("name",g.roadview);var xa=[],ya=[];if(!r||!1===r.onlybase){xa=[va,wa]}if(K){if("overlay"!=r.layertype){xa.push(K)}else{ya.push(K)}}var za=new c.layer.Group({layers:xa}),Aa=null;za.getLayers().forEach(function(a){a.setVisible(!1);Aa=a});Aa.setVisible(!0);var Ba=new c.View({center:[0,0],zoom:2,minZoom:2}),Ca=new c.interaction.Select({layers:[ua],style:function(a){var b=a.get("stageposition");if(!a.get("geometrysolved")){na.getText().setText(""+b);return[na]}ma.getText().setText(""+b);return[ma]},filter:function filter(a){if(0===a.get("stageposition")){return!1}return!0}}),Da=new c.Feature;Da.setProperties({name:"user_accuracy"});Da.setStyle(pa);var Ea=new c.Feature;Ea.setProperties({name:"user_position"});Ea.setStyle(oa);var Fa=new c.layer.Vector({source:new c.source.Vector({features:[Da,Ea]})}),Ga=new c.Feature;Ga.setGeometry(null);Ga.setStyle(qa);var Ha=new c.layer.Vector({source:new c.source.Vector({features:[Ga]})});ra.push(za);ra=ra.concat(ya);ra=ra.concat([ua,Fa,Ha]);var Ia=new c.control.Zoom({target:"navigation",className:"custom-zoom"}),Ja=new c.Map({layers:ra,controls:[Ia],target:"mapplay",view:Ba,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0});Ja.addInteraction(Ca);v(!1,!0);Y=setInterval(function(){v(!1,!1)},o);(function(b){b.getLayers().forEach(function(c){var d=a("<button>",{type:"button",class:"list-group-item list-group-item-action close-modal"}).click(function(){b.getLayers().forEach(function(a){if(a===c){a.setVisible(!0)}else{a.setVisible(!1)}})}),e=a("<div>",{text:c.get("name"),class:"layer-item "+(c.getVisible()?"":"unchecked")}).append(a("<i class='fa fa-check-circle'>"));d.append(e);c.on("change:visible",function(){a(e).toggleClass("unchecked")});a("#layerslist").prepend(d)})})(za);ya.forEach(function(a){A(a)});if(p&&q){var Sa=f.addgpxlayer(Ja,i,j,g,q,"trackgroup");Sa.set("name",Sa.get("title"));var Ka=Sa.getLayers().item(0),La=Ka.get("title"),Ma=La.substring(La.indexOf("</a>")+4);Ka.set("name",Ma);Ka.setVisible(!1);A(Ka)}function s(){if(k&&!Ga.getGeometry()){B(g.nomarks)}else{v(!0,!1)}}function t(){var a=Na.getPosition();u(Ja,a)}function u(a,b,c){var d=a.getView();if(c){d.fit(c,{duration:700})}else{d.animate({zoom:M,center:b,duration:700})}}function v(b,c,e,f){var g,h,i,o;if(k){i=Ga.getGeometry()}else{i=Ea.getGeometry()}if(i){h=sa.writeGeometryObject(i,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})}if(e){H(!0);o=e}if(b){g=h;H(!0)}var q=d.call([{methodname:"mod_treasurehunt_user_progress",args:{userprogress:{treasurehuntid:j,attempttimestamp:m,roadtimestamp:n,playwithoutmoving:k,groupmode:l,initialize:c,location:g,currentposition:p&&!k?h:void 0,selectedanswerid:o,qoaremoved:fa,qrtext:f}}}]);q[0].done(function(d){fa=d.qoaremoved;da=d.roadfinished;ea=d.available;H(!1);if(b||e){if(null!==d.status&&ea){B(d.status.msg)}Ga.setGeometry(null)}if(d.qrexpected){a("#validateqr").show()}else{a("#validateqr").hide()}if(k!=d.playwithoutmoving){k=d.playwithoutmoving;if(!k){Ga.setGeometry(null)}}if(l!=d.groupmode){l=d.groupmode}if(m!==d.attempttimestamp||n!==d.roadtimestamp||c||!ea){m=d.attempttimestamp;n=d.roadtimestamp;if(0<d.attempthistory.length){$=d.attempthistory;_=!0}if(d.attempts||d.firststagegeom){ta.clear();if(d.firststagegeom){ta.addFeatures(sa.readFeatures(d.firststagegeom,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}if(0<d.attempts.features.length){ta.addFeatures(sa.readFeatures(d.attempts,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}}if(d.lastsuccessfulstage){X=d.lastsuccessfulstage;aa=!0;C("#cluepage");if(""!==X.question){ba=!0;a("#validatelocation").hide()}else if(!X.activitysolved){a("#validatelocation").hide()}else{a("#validatelocation").show()}}if(d.firststagegeom||c){ca=!0}x();w();y();z()}if(0<d.infomsg.length){var f="";Z.forEach(function(a){f+="<p>"+a+"</p>"});d.infomsg.forEach(function(a){Z.push(a);f+="<p>"+a+"</p>"});a("#notificationsPopup .update-list").html(f);C("#notificationsPopup")}if(!da){a("#roadended").hide()}if(da||!ea){a("#validatelocation").hide();a("#question_button").hide();a("#roadended").show();Ga.setGeometry(null);k=!1;clearInterval(Y);a("#mapplay").css("opacity","0.8")}}).fail(function(b){a("#errorPopup .play-modal-content").text(b.message);C("#errorPopup");clearInterval(Y)})}function w(){if(ca){var a=ta.getFeatures();if(1===a.length&&a[0].getGeometry()instanceof c.geom.Point){u(Ja,a[0].getGeometry().getCoordinates())}else{u(Ja,null,ta.getExtent())}ca=!1}}function x(){if(aa){X.clue=X.clue.replace(/color/gm,"color-disabled");a("#lastsuccessfulstageclue").html(X.clue);a("#lastsuccessfulstagename").text(X.name);a("#lastsuccesfulstagepos").text(X.position+" / "+X.totalnumber);if(""!==X.question){a("#questionbutton").show()}else{a("#questionbutton").hide()}aa=!1}}function y(){if(ba){X.question=X.question.replace(/color/gm,"color-disabled");a("#questionform").html("<legend>"+X.question+"</legend>");var b=1;a.each(X.answers,function(c,d){var e="answer"+b;d.answertext=d.answertext.replace(/color/gm,"color-disabled");a("#questionform").append("<div class=\"form-check\">\n                <input class=\"form-check-input\" type=\"radio\" name=\"answers\" id=\"".concat(e,"\" value=\"").concat(d.id,"\">\n                <label class=\"form-check-label\" for=\"").concat(e,"\">\n                  ").concat(d.answertext,"\n                </label>\n            </div>"));b++});ba=!1}}function z(){if(_){var b=a("#historylist");b.html("");_=!1;if(0===$.length){a("<li>"+g.noattempts+"</li>").appendTo(b)}else{$.forEach(function(c){a("<li><span class='ui-btn-icon-left "+(c.penalty?"ui-icon-delete failedattempt":"ui-icon-check successfulattempt")+"' style='position:relative'></span>"+c.string+"</li>").appendTo(b)})}}}function A(b){var c=a("<button>",{type:"button",class:"list-group-item list-group-item-action close-modal"}).click(function(){b.setVisible(!b.getVisible())}),d=a("<div>",{text:b.get("name"),class:"layer-item "+(b.getVisible()?"":"unchecked")}).append(a("<i class='fa fa-check-circle'>"));c.append(d);b.on("change:visible",function(){a(d).toggleClass("unchecked")});a("#layerslist").prepend(c)}var Na=new c.Geolocation({projection:Ba.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}});Na.on("change:position",function(){var a=Na.getPosition();Ea.setGeometry(a?new c.geom.Point(a):null);if(Na.get("center")){u(Ja,a);Na.setProperties({center:!1})}if(Na.get("validate_location")){v(!0,!1);Na.setProperties({validate_location:!1})}});Na.on("change:accuracyGeometry",function(){Da.setGeometry(Na.getAccuracyGeometry())});var Oa=!1;Na.on("error",function(b){Na.setProperties({user_denied:!0});B(b.message);if(b.code==b.PERMISSION_DENIED&&p&&!k&&!1==Oa){setTimeout(function(){a("#popupgeoloc").popup("open",{positionTo:"window"});Oa=!0},500)}});Na.setTracking(p);if(!N){Ja.on("pointermove",function(a){if(a.dragging){return}var b=Ja.getEventPixel(a.originalEvent),d=!1;Ja.forEachFeatureAtPixel(b,function(a){if(!(a.getGeometry()instanceof c.geom.MultiPolygon)){d=!0}},{layerFilter:function layerFilter(a){return a===ua}});if(d){Ja.getTargetElement().style.cursor="pointer"}else{Ja.getTargetElement().style.cursor="crosshair"}})}Ca.on("select",function(b){if(1===b.selected.length){var c=b.selected[0].get("name"),d=b.selected[0].get("clue"),e=b.selected[0].get("info"),f="",h="";if(e){f="<p>"+e+"</p>"}if(b.selected[0].get("geometrysolved")){if(c&&d){h=g.stageovercome;f+=E(g.stagename,c);f+=E(g.stageclue,d)}else{h=g.discoveredlocation}}else{h=g.failedlocation}a("#infoStagePopup .title").text(h);a("#infoStagePopup .play-modal-content").html(f);C("#infoStagePopup")}});Ja.on("click",function(a){var b=!1;Ja.forEachFeatureAtPixel(Ja.getEventPixel(a.originalEvent),function(a){if(0===a.get("stageposition")||"user_position"===a.get("name")||"user_accuracy"===a.get("name")){return!1}b=!0});if(k&&!b){var d=Ja.getEventCoordinate(a.originalEvent);Ga.setGeometry(d?new c.geom.Point(d):null)}});a("#searchInput").on("input",function(b){if(ga){ga.abort()}if(ha){clearTimeout(ha)}var d=a("#searchsResults"),f=b.target.value;d.html("");if(f&&2<f.length){a(".search-loading").addClass("active");ha=setTimeout(function(){ga=e.search(f).done(function(b){a(".search-loading").removeClass("active");if(0===b.length){d.html("<li class='list-group-item'>"+g.noresults+"</li>")}else{a.each(b,function(b,e){var f=a("<button>",{type:"button",class:"list-group-item list-group-item-action"}).appendTo(d).click(function(){var a=[parseFloat(e.boundingbox[2]),parseFloat(e.boundingbox[0]),parseFloat(e.boundingbox[3]),parseFloat(e.boundingbox[1])];a=c.proj.transformExtent(a,"EPSG:4326","EPSG:3857");u(Ja,null,a);G("#searchpanel")}),g=a("<div>",{text:e.display_name,class:"search-option"}).append(a("<i class='fa fa-chevron-circle-right'>"));f.append(g)})}}).fail(function(){}).always(function(){ga=null})},400)}});a("#infoStagePopup").on("modal:close",function(){Ca.getFeatures().clear()});a("#acceptupdates").on("click",function(){Z=[]});a("#qrpage").on("modal:open",function(){h.loadQR(I,J)});a("#qrpage").on("modal:close",function(){h.unloadQR(J)});a("#nextcamera").on("click",function(){if(null!==h.detectedCameras){var a=h.getnextwebCam();B("Give access to:"+h.detectedCameras[a].name)}h.setnextwebcam(J)});a(window).on("resize",function(){Ja.updateSize()});if(L){a("#autolocate").on("click",function(){if(Na.get("user_denied")){a("#popupgeoloc").popup("open",{positionTo:"window"})}else{t(!0)}})}a("#infopanel").on("sidebar:close",function(){Ca.getFeatures().clear()});a("#sendLocation").on("click",function(){s(!0)});a("#sendAnswer").on("click",function(b){var c=a("#questionform input[type='radio']:checked");if(!ea){b.preventDefault();B(g.timeexceeded)}else{if(0===c.length){b.preventDefault();B(g.noanswerselected)}else{v(!1,!1,c.val())}}});a("#validatelocation").on("click",function(a){if(da){a.preventDefault();B(g.huntcompleted);return}if(!ea){a.preventDefault();B(g.timeexceeded);return}if(""!==X.question){a.preventDefault();B(g.answerwarning);F("#infopanel");return}if(!X.activitysolved){a.preventDefault();B(g.activitytoendwarning);F("#infopanel")}});a(document).on("click","*[data-rel=\"sidebar\"]",function(b){var c=b.currentTarget,d=a(c.dataset.ref);d.trigger("sidebar:open");d.addClass("active");if(null!==c.dataset.dismissible){a(".sidebar-mask").addClass("active dismissible")}});a(document).on("click",".close-sidebar, .sidebar-mask",function(){var b=a(".sidebar.active");b.trigger("sidebar:close");b.removeClass("active");a(".sidebar-mask").removeClass("active dismissible")});a(document).on("click","*[data-rel=\"modal\"]",function(b){D();var c=b.currentTarget,d=a(c.dataset.ref);d.trigger("modal:open");d.addClass("active");a(c.dataset.ref+" .modal-mask").addClass("active");if(null!==c.dataset.dismissible){a(c.dataset.ref+" .modal-mask").addClass("dismissible")}});a(document).on("click",".close-modal, .modal-mask.dismissible",function(){D()});function B(b){var c=a("<div class='play-toast slide-in-bottom'>".concat(b,"</div>"));c.appendTo(a(".play-toast-container"));setTimeout(function(){return c.addClass("slide-out-top")},3e3);setTimeout(function(){return c.remove()},3500)}function C(b){D();var c=a(b);c.trigger("modal:open");c.addClass("active");a("".concat(b," .modal-mask")).addClass("active dismissible")}function D(){var b=a(".play-modal.active");b.trigger("modal:close");b.removeClass("active");a(".modal-mask").removeClass("active dismissible")}function E(a,b){return"<div class=\"card\">\n          <div class=\"card-body\">\n            <h5 class=\"card-title\">".concat(a,"</h5>\n            <h6 class=\"card-subtitle text-muted\">").concat(b,"</h6>\n          </div>\n      </div>")}function F(b){a(b).addClass("active");a(".sidebar-mask").addClass("active dismissible")}function G(b){a(b).removeClass("active");a(".sidebar-mask").removeClass("active dismissible")}function H(b){if(b){a(".global-loader").addClass("active")}else{a(".global-loader").removeClass("active")}}function I(a){D();B("QR code readed: "+a);v(!1,!1,null,a)}function J(b){if("string"==typeof b){a("#errorQR").text(b)}else{if(null!==b.cameras[b.camera].name){a("#errorQR").text(b.cameras[b.camera].name)}if(1<b.cameras.length){a("#nextcamera").show()}else{a("#nextcamera").hide()}}}}});
//# sourceMappingURL=play.min.js.map
