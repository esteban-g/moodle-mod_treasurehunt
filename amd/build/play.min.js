define ("mod_treasurehunt/play",["jquery","core/url","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/osm-geocoder","mod_treasurehunt/viewgpx","core/str","mod_treasurehunt/jquery.truncate"],function(a,b,c,d,e,f,g){return{playtreasurehunt:function playtreasurehunt(a,b,c,d,e,f,i,j,k,l){var m=["stageovercome","failedlocation","stage","stagename","stageclue","question","noanswerselected","timeexceeded","searching","continue","noattempts","aerialview","roadview","noresults","startfromhere","nomarks","updates","activitytoendwarning","huntcompleted","discoveredlocation","answerwarning","error"],n=m.map(function(a){return{key:a,component:"treasurehunt"}});g.get_strings(n).done(function(g){for(var n=[],o=0;o<m.length;o++){n[m[o]]=g[o]}if("undefined"!=typeof l&&l&&l.custombackgroundurl){var p=new Image;p.addEventListener("load",function(){l.imgwidth=this.naturalWidth;l.imgheight=this.naturalHeight;h(n,a,b,c,d,e,f,i,j,k,l)});p.src=l.custombackgroundurl}else{h(n,a,b,c,d,e,f,i,j,k,l)}})}};function h(g,h,i,j,k,l,m,n,o,p,q){F(!0);var G=null,H=!0,I=15;if(q){if(q.custombackgroundurl){var Ka=c.proj.transformExtent(q.bbox,"EPSG:4326","EPSG:3857");if(!q.geographic){var J=Ka[3]-Ka[1],K=(Ka[2]+Ka[0])/2,L=(Ka[3]+Ka[1])/2,M=Math.round(J/q.imgheight),N=Math.round(q.imgwidth*M),O=Math.round(q.imgheight*M);Ka=[K-N/2,L-O/2,K+N/2,L+O/2];I=5}G=new c.layer.Image({title:q.layername,name:q.layername,type:q.layertype,source:new c.source.ImageStatic({url:q.custombackgroundurl,imageExtent:Ka}),opacity:1})}else if(q.wmsurl){var La={source:new c.source.TileWMS({url:q.wmsurl,params:q.wmsparams}),type:q.layertype,title:q.layername,name:q.layername};if(q.bbox[0]&&q.bbox[1]&&q.bbox[2]&&q.bbox[3]){var Ma=c.proj.transformExtent(q.bbox,"EPSG:4326","EPSG:3857");La.extent=Ma}G=new c.layer.Tile(La)}H=q.geographic}if(!1===H){j=!0;a("#autolocate").hide()}var P=b.imageUrl("success_mark","treasurehunt"),Q=b.imageUrl("failure_mark","treasurehunt"),R=b.imageUrl("my_location","treasurehunt"),S={},T,U=[],V=[],W=!1,X=!1,Y=!1,Z=!1,$=!1,_=!0,aa=!1,ba,ca=0,da=new c.style.Text({textAlign:"center",scale:1.3,fill:new c.style.Fill({color:"#ffffff"}),stroke:new c.style.Stroke({color:"#000000",width:3.5})}),ea=new c.style.Text({textAlign:"center",scale:1.4,fill:new c.style.Fill({color:"#fff"}),stroke:new c.style.Stroke({color:"#0097a7",width:3.5})}),fa=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:P}),text:da,zIndex:"Infinity"}),ga=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:Q}),text:da,zIndex:"Infinity"}),ha=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:P}),text:ea,zIndex:"Infinity"}),ia=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:Q}),text:ea,zIndex:"Infinity"}),ja=new c.style.Style({image:new c.style.Circle({radius:6,fill:new c.style.Fill({color:[0,0,0,1]}),stroke:new c.style.Stroke({color:[255,255,255,1],width:2})})}),ka=new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.3]}),stroke:new c.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),la=new c.style.Style({image:new c.style.Icon({anchor:[.5,.9],opacity:1,scale:1,src:R})}),ma=[],na=new c.format.GeoJSON,oa=new c.source.Vector({projection:"EPSG:3857"}),pa=new c.layer.Vector({source:oa,style:function(a){var b=a.get("stageposition");if(0===b){var d=new c.style.Fill({color:"rgba(0,0,0,0.1)"}),e=new c.style.Stroke({color:"#0097a7",width:2}),f=new c.style.Style({image:new c.style.Circle({fill:d,stroke:e,radius:5}),fill:d,stroke:e,text:new c.style.Text({text:g.startfromhere,textAlign:"center",fill:new c.style.Fill({color:"rgb(255,255,255)"}),stroke:new c.style.Stroke({color:"#0097a7",width:5})})});return[f]}if(!a.get("geometrysolved")){ga.getText().setText(""+b);return[ga]}fa.getText().setText(""+b);return[fa]}}),qa=new c.layer.Tile({visible:!1,source:new c.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})});qa.set("name",g.aerialview);var ra=new c.layer.Tile({source:new c.source.OSM});ra.set("name",g.roadview);var sa=[],ta=[];if(!q||!1===q.onlybase){sa=[qa,ra]}if(G){if("overlay"!=q.layertype){sa.push(G)}else{ta.push(G)}}var ua=new c.layer.Group({layers:sa}),va=null;ua.getLayers().forEach(function(a){a.setVisible(!1);va=a});va.setVisible(!0);var wa=new c.View({center:[0,0],zoom:2,minZoom:2}),xa=new c.interaction.Select({layers:[pa],style:function(a){var b=a.get("stageposition");if(!a.get("geometrysolved")){ia.getText().setText(""+b);return[ia]}ha.getText().setText(""+b);return[ha]},filter:function filter(a){if(0===a.get("stageposition")){return!1}return!0}}),ya=new c.Feature;ya.setProperties({name:"user_accuracy"});ya.setStyle(ka);var za=new c.Feature;za.setProperties({name:"user_position"});za.setStyle(ja);var Aa=new c.layer.Vector({source:new c.source.Vector({features:[ya,za]})}),Ba=new c.Feature;Ba.setGeometry(null);Ba.setStyle(la);var Ca=new c.layer.Vector({source:new c.source.Vector({features:[Ba]})});ma.push(ua);ma=ma.concat(ta);ma=ma.concat([pa,Aa,Ca]);var Da=new c.control.Zoom({target:"navigation",className:"custom-zoom"}),Ea=new c.Map({layers:ma,controls:[Da],target:"mapplay",view:wa,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0});Ea.addInteraction(xa);u(!1,!0);T=setInterval(function(){u(!1,!1)},n);(function(b){b.getLayers().forEach(function(c){var d=a("<button>",{type:"button",class:"list-group-item list-group-item-action close-modal"}).click(function(){b.getLayers().forEach(function(a){if(a===c){a.setVisible(!0)}else{a.setVisible(!1)}})}),e=a("<div>",{text:c.get("name"),class:"layer-item "+(c.getVisible()?"":"unchecked")}).append(a("<i class='fa fa-check-circle'>"));d.append(e);c.on("change:visible",function(){a(e).toggleClass("unchecked")});a("#layerslist").prepend(d)})})(ua);ta.forEach(function(a){z(a)});if(o&&p){var Na=f.addgpxlayer(Ea,h,i,g,p,"trackgroup");Na.set("name",Na.get("title"));var Fa=Na.getLayers().item(0),Ga=Fa.get("title"),Ha=Ga.substring(Ga.indexOf("</a>")+4);Fa.set("name",Ha);Fa.setVisible(!1);z(Fa)}function r(){if(j&&!Ba.getGeometry()){A(g.nomarks)}else{u(!0,!1)}}function s(){var a=Ia.getPosition();t(Ea,a)}function t(a,b,c){var d=a.getView();if(c){d.fit(c,{duration:700})}else{d.animate({zoom:I,center:b,duration:700})}}function u(b,c,e,f){var g,h,n,p;if(j){n=Ba.getGeometry()}else{n=za.getGeometry()}if(n){h=na.writeGeometryObject(n,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})}if(e){F(!0);p=e}if(b){g=h;F(!0)}var q=d.call([{methodname:"mod_treasurehunt_user_progress",args:{userprogress:{treasurehuntid:i,attempttimestamp:l,roadtimestamp:m,playwithoutmoving:j,groupmode:k,initialize:c,location:g,currentposition:o&&!j?h:void 0,selectedanswerid:p,qoaremoved:aa,qrtext:f}}}]);q[0].done(function(d){aa=d.qoaremoved;$=d.roadfinished;_=d.available;F(!1);if(b||e){if(null!==d.status&&_){A(d.status.msg)}Ba.setGeometry(null);if(d.attempts&&d.attempts.features[d.attempts.features.length-1].properties.geometrysolved){B("#cluepage")}}if(d.qrexpected){a("#validateqr").show()}else{a("#validateqr").hide()}if(j!=d.playwithoutmoving){j=d.playwithoutmoving;if(!j){Ba.setGeometry(null)}}if(k!=d.groupmode){k=d.groupmode}if(l!==d.attempttimestamp||m!==d.roadtimestamp||c||!_){l=d.attempttimestamp;m=d.roadtimestamp;if(0<d.attempthistory.length){V=d.attempthistory;W=!0}if(d.attempts||d.firststagegeom){oa.clear();if(d.firststagegeom){oa.addFeatures(na.readFeatures(d.firststagegeom,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}if(0<d.attempts.features.length){oa.addFeatures(na.readFeatures(d.attempts,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}}if(d.lastsuccessfulstage){S=d.lastsuccessfulstage;X=!0;if(""!==S.question){Y=!0;a("#validatelocation").hide();a("#question_button").show()}else if(!S.activitysolved){a("#validatelocation").hide();a("#question_button").show()}else{a("#validatelocation").show();a("#question_button").hide()}}if(d.firststagegeom||c){Z=!0}w();v();x();y()}if(0<d.infomsg.length){var f="";U.forEach(function(a){f+="<p>"+a+"</p>"});d.infomsg.forEach(function(a){U.push(a);f+="<p>"+a+"</p>"});a("#notificationsPopup .update-list").html(f);B("#notificationsPopup")}if(!$){a("#roadended").hide()}if($||!_){a("#validatelocation").hide();a("#question_button").hide();a("#roadended").show();Ba.setGeometry(null);j=!1;clearInterval(T);a("#mapplay").css("opacity","0.8")}}).fail(function(b){a("#errorPopup .play-modal-content").text(b.message);B("#errorPopup");clearInterval(T)})}function v(){if(Z){var a=oa.getFeatures();if(1===a.length&&a[0].getGeometry()instanceof c.geom.Point){t(Ea,a[0].getGeometry().getCoordinates())}else{t(Ea,null,oa.getExtent())}Z=!1}}function w(){if(X){a("#lastsuccessfulstagename").text(g.stage+":"+S.name);a("#lastsuccesfulstagepos").text(S.position+" / "+S.totalnumber);var b;S.clue=S.clue.replace(/color/gm,"color-disabled");a("#lastsuccessfulstageclue").html(S.clue);var c=S.clue.replace(/<(?:.|\n)*?>/gm,"");if(c.length>200){a("#lastsuccessfulstageclue").truncate(200);b=" <a href=\"#historypage\" data-transition=\"none\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui - btn - inline ui - icon - info ui - btn - icon - notext\"></a> ";a("#lastsuccessfulstageclue").append(b)}else{b=S.clue}a("#lastsuccessfulstagename2").text(S.name);a("#lastsuccesfulstagepos2").text(S.position+" / "+S.totalnumber);a("#lastsuccessfulstageclue2").html(S.clue);if(""!==S.question){a("#lastsuccessfulstageclue").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+g.question+"</a>");a("#lastsuccessfulstageclue2").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+g.question+"</a>")}a("#lastsuccessfulstage").collapse("show");X=!1}}function x(){if(Y){S.question=S.question.replace(/color/gm,"color-disabled");a("#questionform").html("<legend>"+S.question+"</legend>");var b=1;a.each(S.answers,function(c,d){var e="answer"+b;d.answertext=d.answertext.replace(/color/gm,"color-disabled");a("#questionform").append("<input type=\"radio\" name=\"answers\" id=\""+e+"\"value=\""+d.id+"\"><label for=\""+e+"\">"+d.answertext+"</label>");b++});Y=!1}}function y(){if(W){var b=a("#historylist");b.html("");W=!1;if(0===V.length){a("<li>"+g.noattempts+"</li>").appendTo(b)}else{V.forEach(function(c){a("<li><span class='ui-btn-icon-left "+(c.penalty?"ui-icon-delete failedattempt":"ui-icon-check successfulattempt")+"' style='position:relative'></span>"+c.string+"</li>").appendTo(b)})}}}function z(b){var c=a("<button>",{type:"button",class:"list-group-item list-group-item-action close-modal"}).click(function(){b.setVisible(!b.getVisible())}),d=a("<div>",{text:b.get("name"),class:"layer-item "+(b.getVisible()?"":"unchecked")}).append(a("<i class='fa fa-check-circle'>"));c.append(d);b.on("change:visible",function(){a(d).toggleClass("unchecked")});a("#layerslist").prepend(c)}var Ia=new c.Geolocation({projection:wa.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}});Ia.on("change:position",function(){var a=Ia.getPosition();za.setGeometry(a?new c.geom.Point(a):null);if(Ia.get("center")){t(Ea,a);Ia.setProperties({center:!1})}if(Ia.get("validate_location")){u(!0,!1);Ia.setProperties({validate_location:!1})}});Ia.on("change:accuracyGeometry",function(){ya.setGeometry(Ia.getAccuracyGeometry())});var Ja=!1;Ia.on("error",function(b){Ia.setProperties({user_denied:!0});A(b.message);if(b.code==b.PERMISSION_DENIED&&o&&!j&&!1==Ja){setTimeout(function(){a("#popupgeoloc").popup("open",{positionTo:"window"});Ja=!0},500)}});Ia.setTracking(o);xa.on("select",function(b){if(1===b.selected.length){var c=b.selected[0].get("name"),d=b.selected[0].get("clue"),e=b.selected[0].get("info"),f="",h="";if(e){f="<p>"+e+"</p>"}if(b.selected[0].get("geometrysolved")){if(c&&d){h=g.stageovercome;f+=C(g.stagename,c);f+=C(g.stageclue,d)}else{h=g.discoveredlocation}}else{h=g.failedlocation}a("#infoStagePopup .title").text(h);a("#infoStagePopup .play-modal-content").html(f);B("#infoStagePopup")}});Ea.on("click",function(a){var b=!1;Ea.forEachFeatureAtPixel(Ea.getEventPixel(a.originalEvent),function(a){if(0===a.get("stageposition")||"user_position"===a.get("name")||"user_accuracy"===a.get("name")){return!1}b=!0});if(j&&!b){var d=Ea.getEventCoordinate(a.originalEvent);Ba.setGeometry(d?new c.geom.Point(d):null)}});a("#searchInput").on("input",function(b){if(ba){ba.abort()}if(ca){clearTimeout(ca)}var d=a("#searchsResults"),f=b.target.value;d.html("");if(f&&2<f.length){a(".search-loading").addClass("active");ca=setTimeout(function(){ba=e.search(f).done(function(b){a(".search-loading").removeClass("active");if(0===b.length){d.html("<li class='list-group-item'>"+g.noresults+"</li>")}else{a.each(b,function(b,e){var f=a("<button>",{type:"button",class:"list-group-item list-group-item-action"}).appendTo(d).click(function(){var a=[parseFloat(e.boundingbox[2]),parseFloat(e.boundingbox[0]),parseFloat(e.boundingbox[3]),parseFloat(e.boundingbox[1])];a=c.proj.transformExtent(a,"EPSG:4326","EPSG:3857");t(Ea,null,a);E("#searchpanel")}),g=a("<div>",{text:e.display_name,class:"search-option"}).append(a("<i class='fa fa-chevron-circle-right'>"));f.append(g)})}}).fail(function(){}).always(function(){ba=null})},400)}});a("#infoStagePopup").on("modal:close",function(){xa.getFeatures().clear()});a("#acceptupdates").on("click",function(){U=[]});a(window).on("resize",function(){Ea.updateSize()});if(H){a("#autolocate").on("click",function(){if(Ia.get("user_denied")){a("#popupgeoloc").popup("open",{positionTo:"window"})}else{s(!0)}})}a("#infopanel").on("sidebar:close",function(){xa.getFeatures().clear()});a("#sendLocation").on("click",function(){r(!0)});a("#sendAnswer").on("click",function(b){var c=a("#questionform input[type='radio']:checked");if(!_){b.preventDefault();A(g.timeexceeded)}else{if(0===c.length){b.preventDefault();A(g.noanswerselected)}else{u(!1,!1,c.val())}}});a("#validatelocation").on("click",function(a){if($){a.preventDefault();A(g.huntcompleted);return}if(!_){a.preventDefault();A(g.timeexceeded);return}if(""!==S.question){a.preventDefault();A(g.answerwarning);D("#infopanel");return}if(!S.activitysolved){a.preventDefault();A(g.activitytoendwarning);D("#infopanel")}});function A(b){var c=a("<div class='play-toast slide-in-bottom'>".concat(b,"</div>"));c.appendTo(a(".play-toast-container"));setTimeout(function(){return c.addClass("slide-out-top")},3e3);setTimeout(function(){return c.remove()},3500)}function B(b){a(b).addClass("active");a("".concat(b," .modal-mask")).addClass("active dismissible")}function C(a,b){return"<div class=\"card\">\n          <div class=\"card-body\">\n            <h5 class=\"card-title\">".concat(a,"</h5>\n            <h6 class=\"card-subtitle text-muted\">").concat(b,"</h6>\n          </div>\n      </div>")}function D(b){a(b).addClass("active");a(".sidebar-mask").addClass("active dismissible")}function E(b){a(b).removeClass("active");a(".sidebar-mask").removeClass("active dismissible")}function F(b){if(b){a(".global-loader").addClass("active")}else{a(".global-loader").removeClass("active")}}}});
//# sourceMappingURL=play.min.js.map
