{"version":3,"sources":["../src/play.js"],"names":["define","$","url","ol","ajax","OSMGeocoder","viewgpx","str","playtreasurehunt","cmid","treasurehuntid","playwithoutmoving","groupmode","lastattempttimestamp","lastroadtimestamp","gameupdatetime","tracking","user","custommapconfig","terms","stringsqueried","map","term","key","component","get_strings","done","strings","i18n","i","length","custombackgroundurl","img","Image","addEventListener","imgwidth","naturalWidth","imgheight","naturalHeight","initplaytreasurehunt","src","setLoading","custombaselayer","geographictools","defaultzoom","supportsTouch","window","navigator","msMaxTouchPoints","customimageextent","proj","transformExtent","bbox","geographic","bboxheight","centerwidth","centerheight","ratiorealmap","Math","round","adjwidth","adjheight","layer","title","layername","name","type","layertype","source","ImageStatic","imageExtent","opacity","wmsurl","options","TileWMS","params","wmsparams","customwmsextent","extent","Tile","hide","parchmenturl","imageUrl","failureurl","markerurl","lastsuccessfulstage","interval","infomsgs","attemptshistory","changesinattemptshistory","changesinlastsuccessfulstage","changesinquestionstage","fitmap","roadfinished","available","qoaremoved","osmGeocoderXHR","osmTimer","text","style","Text","textAlign","scale","fill","Fill","color","stroke","Stroke","width","selectText","defaultstageStyle","Style","image","Icon","anchor","zIndex","failstageStyle","defaultSelectstageStyle","failSelectstageStyle","positionFeatureStyle","Circle","radius","accuracyFeatureStyle","markerFeatureStyle","layers","geoJSONFormat","format","GeoJSON","Vector","projection","attemptslayer","feature","stageposition","get","styles","getText","setText","aeriallayer","visible","BingMaps","imagerySet","maxZoom","set","roadlayer","OSM","layersbase","layersoverlay","onlybase","push","layergroup","Group","toplayer","getLayers","forEach","setVisible","view","View","center","zoom","minZoom","select","interaction","Select","filter","accuracyFeature","Feature","setProperties","setStyle","positionFeature","userPosition","features","markerFeature","setGeometry","markerVector","concat","control","Zoom","target","className","Map","controls","loadTilesWhileAnimating","loadTilesWhileInteracting","addInteraction","renew_source","setInterval","link","class","click","l","linkContent","getVisible","append","on","toggleClass","prepend","overlay","add_layer_to_list","tracklayergroup","addgpxlayer","tracklayer","item","htmltitle","plaintitle","substring","indexOf","validateposition","getGeometry","toast","autocentermap","position","geolocation","getPosition","fly_to","point","getView","fit","duration","animate","location","initialize","selectedanswerid","qrtext","currentposition","coordinates","answerid","writeGeometryObject","dataProjection","featureProjection","geojson","call","methodname","args","userprogress","attempttimestamp","roadtimestamp","response","status","msg","qrexpected","show","attempthistory","attempts","firststagegeom","clear","addFeatures","readFeatures","openModal","question","activitysolved","set_lastsuccessfulstage","fit_map_to_source","set_question","set_attempts_history","infomsg","body","html","clearInterval","css","fail","error","message","getFeatures","geom","Point","getCoordinates","getExtent","clue","replace","totalnumber","counter","each","answers","answer","id","answertext","$historylist","appendTo","attempt","penalty","string","Geolocation","getProjection","trackingOptions","enableHighAccuracy","maximumAge","timeout","validate_location","getAccuracyGeometry","trackinggeolocationwarndispatched","user_denied","code","PERMISSION_DENIED","setTimeout","popup","positionTo","setTracking","evt","dragging","pixel","getEventPixel","originalEvent","hit","forEachFeatureAtPixel","MultiPolygon","layerFilter","getTargetElement","cursor","selected","stagename","stageclue","info","get_block_text","hasFeature","getEventCoordinate","ev","abort","clearTimeout","$searchContainer","value","addClass","search","resp","removeClass","place","parseFloat","boundingbox","closeSidePanel","display_name","always","updateSize","event","preventDefault","val","openSidePanel","document","e","currentTarget","sidebar","dataset","ref","trigger","dismissible","sidebars","closeModal","modal","remove","loading"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module    mod_treasurehunt/play\n * @package   mod_treasurehunt\n * @copyright 2016 onwards Adrian Rodriguez Fernandez <huorwhisp@gmail.com>, Juan Pablo de Castro <jpdecastro@tel.uva.es>\n * @author Adrian Rodriguez <huorwhisp@gmail.com>\n * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n  \"jquery\",\n  \"core/url\",\n  \"mod_treasurehunt/ol\",\n  \"core/ajax\",\n  \"mod_treasurehunt/osm-geocoder\",\n  \"mod_treasurehunt/viewgpx\",\n  \"core/str\",\n  \"mod_treasurehunt/jquery.truncate\"\n  // \"mod_treasurehunt/jquery.mobile-config\",\n  // \"mod_treasurehunt/jquerymobile\"\n], function($, url, ol, ajax, OSMGeocoder, viewgpx, str) {\n  // console.log(\"loading play.js with jquery \" + $().jquery);\n  let init = {\n    playtreasurehunt: function(\n      cmid,\n      treasurehuntid,\n      playwithoutmoving,\n      groupmode,\n      lastattempttimestamp,\n      lastroadtimestamp,\n      gameupdatetime,\n      tracking,\n      user,\n      custommapconfig\n    ) {\n      // I18n strings.\n      let terms = [\n        \"stageovercome\",\n        \"failedlocation\",\n        \"stage\",\n        \"stagename\",\n        \"stageclue\",\n        \"question\",\n        \"noanswerselected\",\n        \"timeexceeded\",\n        \"searching\",\n        \"continue\",\n        \"noattempts\",\n        \"aerialview\",\n        \"roadview\",\n        \"noresults\",\n        \"startfromhere\",\n        \"nomarks\",\n        \"updates\",\n        \"activitytoendwarning\",\n        \"huntcompleted\",\n        \"discoveredlocation\",\n        \"answerwarning\",\n        \"error\"\n      ];\n      // console.log(\"loading i18n strings\");\n      let stringsqueried = terms.map(term => {\n        return { key: term, component: \"treasurehunt\" };\n      });\n      // i18n = i18nplay; // Use globally passed strings. Moodle 3.8 core/str broke with jquery 2.1.4.\n      str.get_strings(stringsqueried).done(strings => {\n        let i18n = [];\n        for (let i = 0; i < terms.length; i++) {\n          i18n[terms[i]] = strings[i]; // JPC: TODO: Global strings.\n        }\n        // i18n = i18nplay;\n        // Detect custom image.\n        if (\n          typeof custommapconfig != \"undefined\" &&\n          custommapconfig &&\n          custommapconfig.custombackgroundurl\n        ) {\n          // console.log(\"Detecting custom background image dimensions.\");\n          // Detect image size.\n          let img = new Image();\n          img.addEventListener(\"load\", function() {\n            custommapconfig.imgwidth = this.naturalWidth;\n            custommapconfig.imgheight = this.naturalHeight;\n            // console.log(\n            //   \"image is \" +\n            //     this.naturalWidth +\n            //     \"x\" +\n            //     this.naturalHeight +\n            //     \"pixels\"\n            // );\n            initplaytreasurehunt(\n              i18n,\n              cmid,\n              treasurehuntid,\n              playwithoutmoving,\n              groupmode,\n              lastattempttimestamp,\n              lastroadtimestamp,\n              gameupdatetime,\n              tracking,\n              user,\n              custommapconfig\n            );\n          });\n          img.src = custommapconfig.custombackgroundurl;\n        } else {\n          initplaytreasurehunt(\n            i18n,\n            cmid,\n            treasurehuntid,\n            playwithoutmoving,\n            groupmode,\n            lastattempttimestamp,\n            lastroadtimestamp,\n            gameupdatetime,\n            tracking,\n            user,\n            custommapconfig\n          );\n        }\n      });\n    } // End of function playtreasurehunt.\n  };\n  return init;\n  // Initialization function.\n  function initplaytreasurehunt(\n    strings,\n    cmid,\n    treasurehuntid,\n    playwithoutmoving,\n    groupmode,\n    lastattempttimestamp,\n    lastroadtimestamp,\n    gameupdatetime,\n    tracking,\n    user,\n    custommapconfig\n  ) {\n    // I18n support.\n    // console.log(\"init player Openlayers\");\n    // $.mobile.loading(\"show\");\n    setLoading(true);\n    let mapprojection = \"EPSG:3857\";\n    let custombaselayer = null;\n    let geographictools = true;\n    let defaultzoom = 15;\n    let supportsTouch = \"ontouchstart\" in window || navigator.msMaxTouchPoints;\n\n    // Support customized base layers.\n    if (custommapconfig) {\n      if (custommapconfig.custombackgroundurl) {\n        // console.log(\"config custom background image\");\n        let customimageextent = ol.proj.transformExtent(\n          custommapconfig.bbox,\n          \"EPSG:4326\",\n          mapprojection\n        );\n        if (!custommapconfig.geographic) {\n          // Round bbox and scales to allow vectorial SVG rendering. (Maintain ratio.)\n          let bboxheight = customimageextent[3] - customimageextent[1];\n          let centerwidth = (customimageextent[2] + customimageextent[0]) / 2;\n          let centerheight = (customimageextent[3] + customimageextent[1]) / 2;\n          let ratiorealmap = Math.round(bboxheight / custommapconfig.imgheight);\n          let adjwidth = Math.round(custommapconfig.imgwidth * ratiorealmap);\n          let adjheight = Math.round(custommapconfig.imgheight * ratiorealmap);\n          customimageextent = [\n            centerwidth - adjwidth / 2,\n            centerheight - adjheight / 2,\n            centerwidth + adjwidth / 2,\n            centerheight + adjheight / 2\n          ];\n          defaultzoom = 5;\n        }\n        custombaselayer = new ol.layer.Image({\n          title: custommapconfig.layername,\n          name: custommapconfig.layername,\n          type: custommapconfig.layertype,\n          source: new ol.source.ImageStatic({\n            url: custommapconfig.custombackgroundurl,\n            imageExtent: customimageextent\n          }),\n          opacity: 1.0\n        });\n      } else if (custommapconfig.wmsurl) {\n        // console.log(\"config custom wms server: \" + custommapconfig.wmsurl);\n        let options = {\n          source: new ol.source.TileWMS({\n            url: custommapconfig.wmsurl,\n            params: custommapconfig.wmsparams\n          }),\n          type: custommapconfig.layertype,\n          title: custommapconfig.layername,\n          name: custommapconfig.layername\n        };\n        if (\n          custommapconfig.bbox[0] &&\n          custommapconfig.bbox[1] &&\n          custommapconfig.bbox[2] &&\n          custommapconfig.bbox[3]\n        ) {\n          let customwmsextent = ol.proj.transformExtent(\n            custommapconfig.bbox,\n            \"EPSG:4326\",\n            mapprojection\n          );\n          options.extent = customwmsextent;\n        }\n        custombaselayer = new ol.layer.Tile(options);\n      }\n\n      geographictools = custommapconfig.geographic;\n    }\n    if (geographictools === false) {\n      // console.log(\"geographic tools disabled\");\n      playwithoutmoving = true;\n      $(\"#autolocate\").hide();\n    }\n\n    let parchmenturl = url.imageUrl(\"success_mark\", \"treasurehunt\");\n    let failureurl = url.imageUrl(\"failure_mark\", \"treasurehunt\");\n    let markerurl = url.imageUrl(\"my_location\", \"treasurehunt\");\n    let lastsuccessfulstage = {};\n    let interval;\n    let infomsgs = [];\n    let attemptshistory = [];\n    let changesinattemptshistory = false;\n    let changesinlastsuccessfulstage = false;\n    let changesinquestionstage = false;\n    let fitmap = false;\n    let roadfinished = false;\n    let available = true;\n    let qoaremoved = false;\n    let osmGeocoderXHR;\n    let osmTimer = 0;\n    /*-------------------------------Styles-----------------------------------*/\n    let text = new ol.style.Text({\n      textAlign: \"center\",\n      scale: 1.3,\n      fill: new ol.style.Fill({\n        color: \"#ffffff\"\n      }),\n      stroke: new ol.style.Stroke({\n        color: \"#000000\",\n        width: 3.5\n      })\n    });\n    let selectText = new ol.style.Text({\n      textAlign: \"center\",\n      scale: 1.4,\n      fill: new ol.style.Fill({\n        color: \"#fff\"\n      }),\n      stroke: new ol.style.Stroke({\n        color: \"#0097a7\",\n        width: 3.5\n      })\n    });\n    let defaultstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.5,\n        src: parchmenturl\n      }),\n      text: text,\n      zIndex: \"Infinity\"\n    });\n    let failstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.5,\n        src: failureurl\n      }),\n      text: text,\n      zIndex: \"Infinity\"\n    });\n    let defaultSelectstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.75,\n        src: parchmenturl\n      }),\n      text: selectText,\n      zIndex: \"Infinity\"\n    });\n    let failSelectstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.75,\n        src: failureurl\n      }),\n      text: selectText,\n      zIndex: \"Infinity\"\n    });\n    let positionFeatureStyle = new ol.style.Style({\n      image: new ol.style.Circle({\n        radius: 6,\n        fill: new ol.style.Fill({\n          color: [0, 0, 0, 1]\n        }),\n        stroke: new ol.style.Stroke({\n          color: [255, 255, 255, 1],\n          width: 2\n        })\n      })\n    });\n    let accuracyFeatureStyle = new ol.style.Style({\n      fill: new ol.style.Fill({\n        color: [255, 255, 255, 0.3]\n      }),\n      stroke: new ol.style.Stroke({\n        color: [0, 0, 0, 0.5],\n        width: 1\n      }),\n      zIndex: -1\n    });\n    let markerFeatureStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 0.9],\n        opacity: 1,\n        scale: 1,\n        src: markerurl\n      })\n    });\n    /*-------------------------------Layers-----------------------------------*/\n    let layers = [];\n    let geoJSONFormat = new ol.format.GeoJSON();\n    let source = new ol.source.Vector({\n      projection: \"EPSG:3857\"\n    });\n    let attemptslayer = new ol.layer.Vector({\n      source: source,\n      style: style_function\n    });\n    let aeriallayer = new ol.layer.Tile({\n      visible: false,\n      source: new ol.source.BingMaps({\n        key: \"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR\",\n        imagerySet: \"AerialWithLabels\",\n        maxZoom: 19\n        // Use maxZoom 19 to see stretched tiles instead of the BingMaps\n        // \"no photos at this zoom level\" tiles\n        // maxZoom: 19.\n      })\n    });\n    aeriallayer.set(\"name\", strings[\"aerialview\"]);\n    let roadlayer = new ol.layer.Tile({\n      source: new ol.source.OSM()\n    });\n    roadlayer.set(\"name\", strings[\"roadview\"]);\n\n    let layersbase = [];\n    let layersoverlay = [];\n    if (!custommapconfig || custommapconfig.onlybase === false) {\n      layersbase = [aeriallayer, roadlayer];\n    }\n    if (custombaselayer) {\n      if (custommapconfig.layertype != \"overlay\") {\n        layersbase.push(custombaselayer);\n      } else {\n        layersoverlay.push(custombaselayer);\n      }\n    }\n    let layergroup = new ol.layer.Group({ layers: layersbase });\n    // All layers hidden except last one.\n    let toplayer = null;\n    layergroup.getLayers().forEach(layer => {\n      layer.setVisible(false);\n      toplayer = layer;\n    });\n    toplayer.setVisible(true);\n\n    let view = new ol.View({\n      center: [0, 0],\n      zoom: 2,\n      minZoom: 2\n    });\n    let select = new ol.interaction.Select({\n      layers: [attemptslayer],\n      style: select_style_function,\n      filter: feature => {\n        if (feature.get(\"stageposition\") === 0) {\n          return false;\n        }\n        return true;\n      }\n    });\n    let accuracyFeature = new ol.Feature();\n    accuracyFeature.setProperties({ name: \"user_accuracy\" });\n    accuracyFeature.setStyle(accuracyFeatureStyle);\n    let positionFeature = new ol.Feature();\n    positionFeature.setProperties({ name: \"user_position\" });\n    positionFeature.setStyle(positionFeatureStyle);\n    let userPosition = new ol.layer.Vector({\n      source: new ol.source.Vector({\n        features: [accuracyFeature, positionFeature]\n      })\n    });\n    let markerFeature = new ol.Feature();\n    markerFeature.setGeometry(null);\n    markerFeature.setStyle(markerFeatureStyle);\n    let markerVector = new ol.layer.Vector({\n      source: new ol.source.Vector({\n        features: [markerFeature]\n      })\n    });\n    layers.push(layergroup);\n    layers = layers.concat(layersoverlay);\n    layers = layers.concat([attemptslayer, userPosition, markerVector]);\n    // New Custom zoom.\n    let zoom = new ol.control.Zoom({\n      target: \"navigation\",\n      className: \"custom-zoom\"\n    });\n    let map = new ol.Map({\n      layers: layers,\n      controls: [zoom], //ol.control.defaults({rotate: false, attribution: false}),\n      target: \"mapplay\",\n      view: view,\n      loadTilesWhileAnimating: true,\n      loadTilesWhileInteracting: true\n    });\n    map.addInteraction(select);\n    // It initializes the game.\n    renew_source(false, true);\n    // For the game is updated every gameupdatetime seconds.\n    interval = setInterval(() => {\n      renew_source(false, false);\n    }, gameupdatetime);\n    // Initialize the page layers.\n\n    add_layergroup_to_list(layergroup);\n    layersoverlay.forEach(overlay => {\n      add_layer_to_list(overlay);\n    });\n    if (tracking && user) {\n      let tracklayergroup = viewgpx.addgpxlayer(\n        map,\n        cmid,\n        treasurehuntid,\n        strings,\n        user,\n        \"trackgroup\"\n      );\n      tracklayergroup.set(\"name\", tracklayergroup.get(\"title\"));\n\n      let tracklayer = tracklayergroup.getLayers().item(0);\n      let htmltitle = tracklayer.get(\"title\"); // Has a picture and a link.\n      let plaintitle = htmltitle.substring(htmltitle.indexOf(\"</a>\") + 4);\n      tracklayer.set(\"name\", plaintitle);\n      tracklayer.setVisible(false);\n      add_layer_to_list(tracklayer);\n    }\n    /*-------------------------------Functions-----------------------------------*/\n    function style_function(feature) {\n      // Get the income level from the feature properties.\n      let stageposition = feature.get(\"stageposition\");\n      if (stageposition === 0) {\n        let fill = new ol.style.Fill({\n          color: \"rgba(0,0,0,0.1)\"\n        });\n        let stroke = new ol.style.Stroke({\n          color: \"#0097a7\",\n          width: 2\n        });\n        let styles = new ol.style.Style({\n          image: new ol.style.Circle({\n            fill: fill,\n            stroke: stroke,\n            radius: 5\n          }),\n          fill: fill,\n          stroke: stroke,\n          text: new ol.style.Text({\n            text: strings[\"startfromhere\"],\n            textAlign: \"center\",\n            fill: new ol.style.Fill({\n              color: \"rgb(255,255,255)\"\n            }),\n            stroke: new ol.style.Stroke({\n              color: \"#0097a7\",\n              width: 5\n            })\n          })\n        });\n        return [styles];\n      }\n      if (!feature.get(\"geometrysolved\")) {\n        // Don't change the scale with the map. This is confusing failstageStyle.getImage().setScale((view.getZoom() / 30));.\n        failstageStyle.getText().setText(\"\" + stageposition);\n        return [failstageStyle];\n      }\n      // Don't change the scale with the map. This is confusing  defaultstageStyle.getImage().setScale((view.getZoom() / 100));.\n      defaultstageStyle.getText().setText(\"\" + stageposition);\n      return [defaultstageStyle];\n    }\n    function select_style_function(feature) {\n      let stageposition = feature.get(\"stageposition\");\n      if (!feature.get(\"geometrysolved\")) {\n        failSelectstageStyle.getText().setText(\"\" + stageposition);\n        return [failSelectstageStyle];\n      }\n      defaultSelectstageStyle.getText().setText(\"\" + stageposition);\n      return [defaultSelectstageStyle];\n    }\n    function validateposition() {\n      if (playwithoutmoving && !markerFeature.getGeometry()) {\n        toast(strings[\"nomarks\"]);\n      } else {\n        renew_source(true, false);\n      }\n    }\n    function autocentermap() {\n      const position = geolocation.getPosition();\n      fly_to(map, position);\n    }\n    function fly_to(map, point, extent) {\n      let duration = 700;\n      let view = map.getView();\n      if (extent) {\n        view.fit(extent, {\n          duration: duration\n        });\n      } else {\n        view.animate({\n          zoom: defaultzoom,\n          center: point,\n          duration: duration\n        });\n      }\n    }\n    /**\n     * Updates the model of the game.\n     * Notifies a new location for validation or a new answer to a question.\n     * @param {boolean} location requests a location validation.\n     * @param {boolean} initialize\n     * @param {int} selectedanswerid submits an answer to a question\n     * @param {string} qrtext submits a text scanned from a QRCode\n     * @returns {undefined}\n     */\n    function renew_source(location, initialize, selectedanswerid, qrtext) {\n      // let position holds the potition to be evaluated. undef if no evaluation requested\n      let position;\n      let currentposition;\n      let coordinates;\n      let answerid;\n\n      if (playwithoutmoving) {\n        coordinates = markerFeature.getGeometry();\n      } else {\n        coordinates = positionFeature.getGeometry();\n      }\n      if (coordinates) {\n        currentposition = geoJSONFormat.writeGeometryObject(coordinates, {\n          dataProjection: \"EPSG:4326\",\n          featureProjection: \"EPSG:3857\"\n        });\n      }\n      if (selectedanswerid) {\n        setLoading(true);\n        answerid = selectedanswerid;\n      }\n      if (location) {\n        position = currentposition;\n        setLoading(true);\n      }\n      let geojson = ajax.call([\n        {\n          methodname: \"mod_treasurehunt_user_progress\",\n          args: {\n            userprogress: {\n              treasurehuntid: treasurehuntid,\n              attempttimestamp: lastattempttimestamp,\n              roadtimestamp: lastroadtimestamp,\n              playwithoutmoving: playwithoutmoving,\n              groupmode: groupmode,\n              initialize: initialize,\n              location: position,\n              currentposition:\n                tracking && !playwithoutmoving ? currentposition : undefined, // only for tracking in mobility.\n              selectedanswerid: answerid,\n              qoaremoved: qoaremoved,\n              qrtext: qrtext\n            }\n          }\n        }\n      ]);\n      geojson[0]\n        .done(response => {\n          qoaremoved = response.qoaremoved;\n          roadfinished = response.roadfinished;\n          available = response.available;\n          setLoading(false);\n\n          // If I have sent a location or an answer I print out whether it is correct or not.\n          if (location || selectedanswerid) {\n            if (response.status !== null && available) {\n              toast(response.status.msg);\n            }\n            markerFeature.setGeometry(null);\n          }\n          if (response.qrexpected) {\n            $(\"#validateqr\").show();\n          } else {\n            $(\"#validateqr\").hide();\n          }\n          // If change the game mode (mobile or static).\n          if (playwithoutmoving != response.playwithoutmoving) {\n            playwithoutmoving = response.playwithoutmoving;\n            if (!playwithoutmoving) {\n              markerFeature.setGeometry(null);\n            }\n          }\n          // If change the group mode.\n          if (groupmode != response.groupmode) {\n            groupmode = response.groupmode;\n          }\n          if (\n            lastattempttimestamp !== response.attempttimestamp ||\n            lastroadtimestamp !== response.roadtimestamp ||\n            initialize ||\n            !available\n          ) {\n            lastattempttimestamp = response.attempttimestamp;\n            lastroadtimestamp = response.roadtimestamp;\n            if (response.attempthistory.length > 0) {\n              attemptshistory = response.attempthistory;\n              changesinattemptshistory = true;\n            }\n            // Compruebo si es distinto de null, lo que indica que se ha actualizado.\n            if (response.attempts || response.firststagegeom) {\n              source.clear();\n              if (response.firststagegeom) {\n                source.addFeatures(\n                  geoJSONFormat.readFeatures(response.firststagegeom, {\n                    dataProjection: \"EPSG:4326\",\n                    featureProjection: \"EPSG:3857\"\n                  })\n                );\n              }\n              if (response.attempts.features.length > 0) {\n                source.addFeatures(\n                  geoJSONFormat.readFeatures(response.attempts, {\n                    dataProjection: \"EPSG:4326\",\n                    featureProjection: \"EPSG:3857\"\n                  })\n                );\n              }\n            }\n            // Check if it exists, which indicates that it has been updated.\n            if (response.lastsuccessfulstage) {\n              lastsuccessfulstage = response.lastsuccessfulstage;\n              changesinlastsuccessfulstage = true;\n              openModal(\"#cluepage\");\n              // If the stage is not solved I will notify you that there are changes.\n              if (lastsuccessfulstage.question !== \"\") {\n                changesinquestionstage = true;\n                $(\"#validatelocation\").hide();\n              } else if (!lastsuccessfulstage.activitysolved) {\n                $(\"#validatelocation\").hide();\n              } else {\n                $(\"#validatelocation\").show();\n              }\n            }\n            // Check if it is the first geometry or it is being initialized and center the map.\n            if (response.firststagegeom || initialize) {\n              fitmap = true;\n            }\n\n            set_lastsuccessfulstage();\n            fit_map_to_source();\n            set_question();\n            set_attempts_history();\n          }\n          if (response.infomsg.length > 0) {\n            let body = \"\";\n            infomsgs.forEach(msg => {\n              body += \"<p>\" + msg + \"</p>\";\n            });\n            response.infomsg.forEach(msg => {\n              infomsgs.push(msg);\n              body += \"<p>\" + msg + \"</p>\";\n            });\n            $(\"#notificationsPopup .update-list\").html(body);\n            openModal(\"#notificationsPopup\");\n          }\n          if (!roadfinished) {\n            $(\"#roadended\").hide();\n          }\n          if (roadfinished || !available) {\n            $(\"#validatelocation\").hide();\n            $(\"#question_button\").hide();\n            $(\"#roadended\").show();\n            markerFeature.setGeometry(null);\n            playwithoutmoving = false;\n            clearInterval(interval);\n            $(\"#mapplay\").css(\"opacity\", \"0.8\");\n          }\n        })\n        .fail(error => {\n          $(\"#errorPopup .play-modal-content\").text(error.message);\n          openModal(\"#errorPopup\");\n          clearInterval(interval);\n        });\n    }\n    function fit_map_to_source() {\n      if (fitmap) {\n        let features = source.getFeatures();\n        if (\n          features.length === 1 &&\n          features[0].getGeometry() instanceof ol.geom.Point\n        ) {\n          fly_to(map, features[0].getGeometry().getCoordinates());\n        } else {\n          fly_to(map, null, source.getExtent());\n        }\n\n        fitmap = false;\n      }\n    }\n    function set_lastsuccessfulstage() {\n      if (changesinlastsuccessfulstage) {\n        // Clean color styles from clue.\n        lastsuccessfulstage.clue = lastsuccessfulstage.clue.replace(\n          /color/gm,\n          \"color-disabled\"\n        );\n        $(\"#lastsuccessfulstageclue\").html(lastsuccessfulstage.clue);\n\n        $(\"#lastsuccessfulstagename\").text(lastsuccessfulstage.name);\n        $(\"#lastsuccesfulstagepos\").text(\n          lastsuccessfulstage.position + \" / \" + lastsuccessfulstage.totalnumber\n        );\n        if (lastsuccessfulstage.question !== \"\") {\n          $(\"#questionbutton\").show();\n        } else {\n          $(\"#questionbutton\").hide();\n        }\n        changesinlastsuccessfulstage = false;\n      }\n    }\n    function set_question() {\n      if (changesinquestionstage) {\n        // Clean color tag.\n        lastsuccessfulstage.question = lastsuccessfulstage.question.replace(\n          /color/gm,\n          \"color-disabled\"\n        );\n\n        $(\"#questionform\").html(\n          \"<legend>\" + lastsuccessfulstage.question + \"</legend>\"\n        );\n        let counter = 1;\n        $.each(lastsuccessfulstage.answers, (key, answer) => {\n          let id = \"answer\" + counter;\n          // Clean color tag.\n          answer.answertext = answer.answertext.replace(\n            /color/gm,\n            \"color-disabled\"\n          );\n\n          $(\"#questionform\").append(\n            `<div class=\"form-check\">\n                <input class=\"form-check-input\" type=\"radio\" name=\"answers\" id=\"${id}\" value=\"${answer.id}\">\n                <label class=\"form-check-label\" for=\"${id}\">\n                  ${answer.answertext}\n                </label>\n            </div>`\n          );\n          counter++;\n        });\n\n        // $(\"#questionform\")\n        //   .html(questionform)\n        //   .scrollTop();\n        // // Enhance this with jquery mobile.\n        // // JPC: It doesn't work in some cases (i.e. Moodle 3.7) probably some interaction with jquery, jqueryui and jquerymobile.\n        // // When the radio controls are not correctly shown its better to show the native controls.\n        // $(\"#questionform\").enhanceWithin();\n        // setTimeout(\n        //   () =>\n        //     $(\"#questionform input\").removeClass(\"ui-helper-hidden-accessible\"),\n        //   1\n        // ); //.controlgroup(\"refresh\");\n        changesinquestionstage = false;\n      }\n    }\n    function set_attempts_history() {\n      // I'm checking to see if there have been any changes since the last time.\n      if (changesinattemptshistory) {\n        let $historylist = $(\"#historylist\"); // TODO: Why the variable starts with $?\n        // Lo reinicio\n        $historylist.html(\"\");\n        changesinattemptshistory = false;\n        if (attemptshistory.length === 0) {\n          $(\"<li>\" + strings[\"noattempts\"] + \"</li>\").appendTo($historylist);\n        } else {\n          // Anado cada intento\n          attemptshistory.forEach(attempt => {\n            $(\n              \"<li><span class='ui-btn-icon-left \" +\n                (attempt.penalty\n                  ? \"ui-icon-delete failedattempt\"\n                  : \"ui-icon-check successfulattempt\") +\n                \"' style='position:relative'></span>\" +\n                attempt.string +\n                \"</li>\"\n            ).appendTo($historylist);\n          });\n        }\n      }\n    }\n    function add_layer_to_list(layer) {\n      let link = $(\"<button>\", {\n        type: \"button\",\n        class: \"list-group-item list-group-item-action close-modal\"\n      }).click(() => {\n        layer.setVisible(!layer.getVisible());\n      });\n      let linkContent = $(\"<div>\", {\n        text: layer.get(\"name\"),\n        class: \"layer-item \" + (layer.getVisible() ? \"\" : \"unchecked\")\n      }).append($(\"<i class='fa fa-check-circle'>\"));\n      link.append(linkContent);\n      layer.on(\"change:visible\", () => {\n        $(linkContent).toggleClass(\"unchecked\");\n      });\n      $(\"#layerslist\").prepend(link);\n    }\n\n    function add_layergroup_to_list(layergroup) {\n      layergroup.getLayers().forEach(layer => {\n        let link = $(\"<button>\", {\n          type: \"button\",\n          class: \"list-group-item list-group-item-action close-modal\"\n        }).click(() => {\n          layergroup.getLayers().forEach(l => {\n            if (l === layer) {\n              l.setVisible(true);\n            } else {\n              l.setVisible(false);\n            }\n          });\n        });\n        let linkContent = $(\"<div>\", {\n          text: layer.get(\"name\"),\n          class: \"layer-item \" + (layer.getVisible() ? \"\" : \"unchecked\")\n        }).append($(\"<i class='fa fa-check-circle'>\"));\n        link.append(linkContent);\n        layer.on(\"change:visible\", () => {\n          $(linkContent).toggleClass(\"unchecked\");\n        });\n        $(\"#layerslist\").prepend(link);\n      });\n    }\n\n    /**\n     * Geolocation component\n     * @type ol.Geolocation\n     */\n    let geolocation = new ol.Geolocation(\n      /** @type {olx.GeolocationOptions} */ ({\n        projection: view.getProjection(),\n        trackingOptions: {\n          enableHighAccuracy: true,\n          maximumAge: 0,\n          timeout: 10000\n        }\n      })\n    );\n    /*-------------------------------Events-----------------------------------*/\n    geolocation.on(\"change:position\", () => {\n      let coordinates = geolocation.getPosition();\n      positionFeature.setGeometry(\n        coordinates ? new ol.geom.Point(coordinates) : null\n      );\n      // The map must be re-centered in the new position\n      if (geolocation.get(\"center\")) {\n        fly_to(map, coordinates);\n        geolocation.setProperties({ center: false }); // Disable center request. Deprecated.\n      }\n      // the new position must be evaluated\n      if (geolocation.get(\"validate_location\")) {\n        renew_source(true, false);\n        geolocation.setProperties({ validate_location: false }); // Disable validate_location request. Deprecated.\n      }\n    });\n\n    geolocation.on(\"change:accuracyGeometry\", () => {\n      accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());\n    });\n\n    let trackinggeolocationwarndispatched = false;\n    geolocation.on(\"error\", error => {\n      // $.mobile.loading(\"hide\");\n      geolocation.setProperties({ user_denied: true });\n      toast(error.message);\n      if (\n        error.code == error.PERMISSION_DENIED &&\n        tracking &&\n        !playwithoutmoving &&\n        trackinggeolocationwarndispatched == false\n      ) {\n        setTimeout(() => {\n          $(\"#popupgeoloc\").popup(\"open\", { positionTo: \"window\" });\n          trackinggeolocationwarndispatched = true;\n        }, 500);\n      }\n    });\n    geolocation.setTracking(tracking); // Start position tracking.\n\n    // If it is not a touch screen, show pointer when hovering over an attempt\n    if (!supportsTouch) {\n      map.on(\"pointermove\", evt => {\n        if (evt.dragging) {\n          return;\n        }\n        const pixel = map.getEventPixel(evt.originalEvent);\n        let hit = false;\n        map.forEachFeatureAtPixel(\n          pixel,\n          feature => {\n            if (!(feature.getGeometry() instanceof ol.geom.MultiPolygon)) {\n              hit = true;\n            }\n          },\n          { layerFilter: layer => layer === attemptslayer }\n        );\n        if (hit) {\n          map.getTargetElement().style.cursor = \"pointer\";\n        } else {\n          map.getTargetElement().style.cursor = \"crosshair\";\n        }\n      });\n    }\n    // On select location feature\n    select.on(\"select\", features => {\n      if (features.selected.length === 1) {\n        let stagename = features.selected[0].get(\"name\");\n        let stageclue = features.selected[0].get(\"clue\");\n        let info = features.selected[0].get(\"info\");\n        let body = \"\";\n        let title = \"\";\n        if (info) {\n          body = \"<p>\" + info + \"</p>\";\n        }\n        if (features.selected[0].get(\"geometrysolved\")) {\n          if (stagename && stageclue) {\n            title = strings[\"stageovercome\"];\n            body += get_block_text(strings[\"stagename\"], stagename);\n            body += get_block_text(strings[\"stageclue\"], stageclue);\n          } else {\n            title = strings[\"discoveredlocation\"];\n          }\n        } else {\n          title = strings[\"failedlocation\"];\n        }\n        $(\"#infoStagePopup .title\").text(title);\n        $(\"#infoStagePopup .play-modal-content\").html(body);\n        openModal(\"#infoStagePopup\");\n      }\n    });\n\n    // Change marker feature position on user click if play mode is play without moving\n    map.on(\"click\", evt => {\n      // Check if has a feature on click event position.\n      let hasFeature = false;\n      map.forEachFeatureAtPixel(\n        map.getEventPixel(evt.originalEvent),\n        feature => {\n          if (\n            feature.get(\"stageposition\") === 0 ||\n            feature.get(\"name\") === \"user_position\" ||\n            feature.get(\"name\") === \"user_accuracy\"\n          ) {\n            return false;\n          }\n          hasFeature = true;\n        }\n      );\n      if (playwithoutmoving && !hasFeature) {\n        let coordinates = map.getEventCoordinate(evt.originalEvent);\n        markerFeature.setGeometry(\n          coordinates ? new ol.geom.Point(coordinates) : null\n        );\n      }\n    });\n\n    $(\"#searchInput\").on(\"input\", ev => {\n      // Abort xhr request if a new one arrives\n      if (osmGeocoderXHR) {\n        osmGeocoderXHR.abort();\n      }\n      if (osmTimer) {\n        clearTimeout(osmTimer);\n      }\n      const $searchContainer = $(\"#searchsResults\");\n      const value = ev.target.value;\n      let html = \"\";\n      $searchContainer.html(html);\n      if (value && value.length > 2) {\n        $(\".search-loading\").addClass(\"active\");\n        osmTimer = setTimeout(() => {\n          osmGeocoderXHR = OSMGeocoder.search(value)\n            .done(resp => {\n              $(\".search-loading\").removeClass(\"active\");\n              if (resp.length === 0) {\n                $searchContainer.html(\n                  \"<li class='list-group-item'>\" +\n                    strings[\"noresults\"] +\n                    \"</li>\"\n                );\n              } else {\n                $.each(resp, (i, place) => {\n                  let link = $(\"<button>\", {\n                    type: \"button\",\n                    class: \"list-group-item list-group-item-action\"\n                  })\n                    .appendTo($searchContainer)\n                    .click(() => {\n                      let extent = [];\n                      extent[0] = parseFloat(place.boundingbox[2]);\n                      extent[1] = parseFloat(place.boundingbox[0]);\n                      extent[2] = parseFloat(place.boundingbox[3]);\n                      extent[3] = parseFloat(place.boundingbox[1]);\n                      extent = ol.proj.transformExtent(\n                        extent,\n                        \"EPSG:4326\",\n                        \"EPSG:3857\"\n                      );\n                      fly_to(map, null, extent);\n                      closeSidePanel(\"#searchpanel\");\n                    });\n                  let linkContent = $(\"<div>\", {\n                    text: place.display_name,\n                    class: \"search-option\"\n                  }).append($(\"<i class='fa fa-chevron-circle-right'>\"));\n                  link.append(linkContent);\n                });\n              }\n            })\n            .fail(() => {})\n            .always(() => {\n              osmGeocoderXHR = null;\n            });\n        }, 400);\n      }\n    });\n\n    // Clear selected features after info stage popup close.\n    $(\"#infoStagePopup\").on(\"modal:close\", () => {\n      select.getFeatures().clear();\n    });\n    // Clear array of info messages after user accept updates\n    $(\"#acceptupdates\").on(\"click\", () => {\n      infomsgs = [];\n    });\n\n    // Redraw map on resize window.\n    $(window).on(\"resize\", () => {\n      map.updateSize();\n    });\n\n    //Buttons events.\n    if (geographictools) {\n      $(\"#autolocate\").on(\"click\", () => {\n        if (geolocation.get(\"user_denied\")) {\n          $(\"#popupgeoloc\").popup(\"open\", { positionTo: \"window\" });\n        } else {\n          autocentermap(true);\n        }\n      });\n    }\n\n    $(\"#infopanel\").on(\"sidebar:close\", () => {\n      select.getFeatures().clear();\n    });\n\n    $(\"#sendLocation\").on(\"click\", () => {\n      validateposition(true);\n    });\n\n    $(\"#sendAnswer\").on(\"click\", event => {\n      // Selecciono la respuesta.\n      let selected = $(\"#questionform input[type='radio']:checked\");\n      if (!available) {\n        event.preventDefault();\n        toast(strings[\"timeexceeded\"]);\n      } else {\n        if (selected.length === 0) {\n          event.preventDefault();\n          toast(strings[\"noanswerselected\"]);\n        } else {\n          renew_source(false, false, selected.val());\n        }\n      }\n    });\n\n    $(\"#validatelocation\").on(\"click\", event => {\n      if (roadfinished) {\n        event.preventDefault();\n        toast(strings[\"huntcompleted\"]);\n        return;\n      }\n      if (!available) {\n        event.preventDefault();\n        toast(strings[\"timeexceeded\"]);\n        return;\n      }\n      if (lastsuccessfulstage.question !== \"\") {\n        event.preventDefault();\n        toast(strings[\"answerwarning\"]);\n        openSidePanel(\"#infopanel\");\n        return;\n      }\n      if (!lastsuccessfulstage.activitysolved) {\n        event.preventDefault();\n        toast(strings[\"activitytoendwarning\"]);\n        openSidePanel(\"#infopanel\");\n        return;\n      }\n    });\n\n    /* Sidebar events */\n    $(document).on(\"click\", '*[data-rel=\"sidebar\"]', e => {\n      const target = e.currentTarget;\n      const sidebar = $(target.dataset.ref);\n      sidebar.trigger(\"sidebar:open\");\n      sidebar.addClass(\"active\");\n      if (target.dataset.dismissible !== null) {\n        $(\".sidebar-mask\").addClass(\"active dismissible\");\n      }\n    });\n\n    $(document).on(\"click\", \".close-sidebar, .sidebar-mask\", () => {\n      const sidebars = $(\".sidebar.active\");\n      sidebars.trigger(\"sidebar:close\");\n      sidebars.removeClass(\"active\");\n      $(\".sidebar-mask\").removeClass(\"active dismissible\");\n    });\n\n    /* Modal events */\n    $(document).on(\"click\", '*[data-rel=\"modal\"]', e => {\n      closeModal();\n      const target = e.currentTarget;\n      const modal = $(target.dataset.ref);\n      modal.trigger(\"modal:open\");\n      modal.addClass(\"active\");\n      $(target.dataset.ref + \" .modal-mask\").addClass(\"active\");\n      if (target.dataset.dismissible !== null) {\n        $(target.dataset.ref + \" .modal-mask\").addClass(\"dismissible\");\n      }\n    });\n\n    $(document).on(\"click\", \".close-modal, .modal-mask.dismissible\", () => {\n      closeModal();\n    });\n\n    /*-------------------------------Initialize page -------------*/\n\n    /*-------------------------------Help functions -------------*/\n    function toast(msg) {\n      const toast = $(`<div class='play-toast slide-in-bottom'>${msg}</div>`);\n      toast.appendTo($(\".play-toast-container\"));\n      // Out animation after 3s\n      setTimeout(() => toast.addClass(\"slide-out-top\"), 3000);\n      // Remove element after 3,5s\n      setTimeout(() => toast.remove(), 3500);\n    }\n    function openModal(id) {\n      // Close previous modal\n      closeModal();\n      const modal = $(id);\n      modal.trigger(\"modal:open\");\n      modal.addClass(\"active\");\n      $(`${id} .modal-mask`).addClass(\"active dismissible\");\n    }\n    function closeModal() {\n      const modal = $(\".play-modal.active\");\n      modal.trigger(\"modal:close\");\n      modal.removeClass(\"active\");\n      $(\".modal-mask\").removeClass(\"active dismissible\");\n    }\n    function get_block_text(title, body) {\n      return `<div class=\"card\">\n          <div class=\"card-body\">\n            <h5 class=\"card-title\">${title}</h5>\n            <h6 class=\"card-subtitle text-muted\">${body}</h6>\n          </div>\n      </div>`;\n    }\n    function openSidePanel(id) {\n      $(id).addClass(\"active\");\n      $(\".sidebar-mask\").addClass(\"active dismissible\");\n    }\n    function closeSidePanel(id) {\n      $(id).removeClass(\"active\");\n      $(\".sidebar-mask\").removeClass(\"active dismissible\");\n    }\n    function setLoading(loading) {\n      if (loading) {\n        $(\".global-loader\").addClass(\"active\");\n      } else {\n        $(\".global-loader\").removeClass(\"active\");\n      }\n    }\n  }\n});\n"],"file":"play.min.js"}