{"version":3,"sources":["../src/play.js"],"names":["define","$","url","ol","ajax","GeocoderJS","OSMGeocoder","viewgpx","str","playtreasurehunt","cmid","treasurehuntid","playwithoutmoving","groupmode","lastattempttimestamp","lastroadtimestamp","gameupdatetime","tracking","user","custommapconfig","terms","stringsqueried","map","term","key","component","get_strings","done","strings","i18n","i","length","custombackgroundurl","img","Image","addEventListener","imgwidth","naturalWidth","imgheight","naturalHeight","initplaytreasurehunt","src","setLoading","custombaselayer","geographictools","defaultzoom","customimageextent","proj","transformExtent","bbox","geographic","bboxheight","centerwidth","centerheight","ratiorealmap","Math","round","adjwidth","adjheight","layer","title","layername","name","type","layertype","source","ImageStatic","imageExtent","opacity","wmsurl","options","TileWMS","params","wmsparams","customwmsextent","extent","Tile","hide","parchmenturl","imageUrl","failureurl","markerurl","lastsuccessfulstage","interval","infomsgs","attemptshistory","changesinattemptshistory","changesinlastsuccessfulstage","changesinquestionstage","fitmap","roadfinished","available","qoaremoved","osmGeocoderXHR","osmTimer","text","style","Text","textAlign","scale","fill","Fill","color","stroke","Stroke","width","selectText","defaultstageStyle","Style","image","Icon","anchor","zIndex","failstageStyle","defaultSelectstageStyle","failSelectstageStyle","positionFeatureStyle","Circle","radius","accuracyFeatureStyle","markerFeatureStyle","layers","geoJSONFormat","format","GeoJSON","Vector","projection","attemptslayer","feature","stageposition","get","styles","getText","setText","aeriallayer","visible","BingMaps","imagerySet","maxZoom","set","roadlayer","OSM","layersbase","layersoverlay","onlybase","push","layergroup","Group","toplayer","getLayers","forEach","setVisible","view","View","center","zoom","minZoom","select","interaction","Select","filter","accuracyFeature","Feature","setProperties","setStyle","positionFeature","userPosition","features","markerFeature","setGeometry","markerVector","concat","control","Zoom","target","className","Map","controls","loadTilesWhileAnimating","loadTilesWhileInteracting","addInteraction","renew_source","setInterval","link","class","click","l","linkContent","getVisible","append","on","toggleClass","prepend","overlay","add_layer_to_list","tracklayergroup","addgpxlayer","tracklayer","item","htmltitle","plaintitle","substring","indexOf","validateposition","getGeometry","toast","autocentermap","position","geolocation","getPosition","fly_to","point","getView","fit","duration","animate","location","initialize","selectedanswerid","qrtext","currentposition","coordinates","answerid","writeGeometryObject","dataProjection","featureProjection","geojson","call","methodname","args","userprogress","attempttimestamp","roadtimestamp","response","status","qrexpected","show","attempthistory","attempts","firststagegeom","clear","addFeatures","readFeatures","question","activitysolved","set_lastsuccessfulstage","fit_map_to_source","set_question","set_attempts_history","infomsg","msg","clearInterval","css","fail","getFeatures","geom","Point","getCoordinates","getExtent","totalnumber","briefing","clue","replace","html","clueplaintext","truncate","collapse","counter","each","answers","answer","id","answertext","$historylist","appendTo","attempt","penalty","string","Geolocation","getProjection","trackingOptions","enableHighAccuracy","maximumAge","timeout","validate_location","getAccuracyGeometry","trackinggeolocationwarndispatched","error","user_denied","message","code","PERMISSION_DENIED","setTimeout","popup","positionTo","setTracking","selected","openSidePanel","stagename","stageclue","info","evt","hasFeature","forEachFeatureAtPixel","getEventPixel","originalEvent","getEventCoordinate","ev","abort","clearTimeout","$searchContainer","value","search","resp","place","parseFloat","boundingbox","closeSidePanel","display_name","always","document","maxHeight","window","height","remove","updateSize","event","preventDefault","val","left","top","delay","fadeOut","addClass","removeClass","loading"],"mappings":"AAuBAA,OAAM,yBAAC,CACL,QADK,CAEL,UAFK,CAGL,qBAHK,CAIL,WAJK,CAKL,2BALK,CAML,+BANK,CAOL,0BAPK,CAQL,UARK,CASL,kCATK,CAAD,CAYH,SAASC,CAAT,CAAYC,CAAZ,CAAiBC,CAAjB,CAAqBC,CAArB,CAA2BC,CAA3B,CAAuCC,CAAvC,CAAoDC,CAApD,CAA6DC,CAA7D,CAAkE,CAuGnE,MArGW,CACTC,gBAAgB,CAAE,0BAChBC,CADgB,CAEhBC,CAFgB,CAGhBC,CAHgB,CAIhBC,CAJgB,CAKhBC,CALgB,CAMhBC,CANgB,CAOhBC,CAPgB,CAQhBC,CARgB,CAShBC,CATgB,CAUhBC,CAVgB,CAWhB,IAEIC,CAAAA,CAAK,CAAG,CACV,eADU,CAEV,gBAFU,CAGV,OAHU,CAIV,WAJU,CAKV,WALU,CAMV,UANU,CAOV,kBAPU,CAQV,cARU,CASV,WATU,CAUV,UAVU,CAWV,YAXU,CAYV,YAZU,CAaV,UAbU,CAcV,WAdU,CAeV,eAfU,CAgBV,SAhBU,CAiBV,SAjBU,CAkBV,sBAlBU,CAmBV,eAnBU,CAoBV,oBApBU,CAqBV,eArBU,CAsBV,OAtBU,CAFZ,CA2BIC,CAAc,CAAGD,CAAK,CAACE,GAAN,CAAU,SAAAC,CAAI,CAAI,CACrC,MAAO,CAAEC,GAAG,CAAED,CAAP,CAAaE,SAAS,CAAE,cAAxB,CACR,CAFoB,CA3BrB,CA+BAjB,CAAG,CAACkB,WAAJ,CAAgBL,CAAhB,EAAgCM,IAAhC,CAAqC,SAAAC,CAAO,CAAI,CAE9C,OADIC,CAAAA,CAAI,CAAG,EACX,CAASC,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGV,CAAK,CAACW,MAA1B,CAAkCD,CAAC,EAAnC,CAAuC,CACrCD,CAAI,CAACT,CAAK,CAACU,CAAD,CAAN,CAAJ,CAAiBF,CAAO,CAACE,CAAD,CACzB,CAGD,GAC4B,WAA1B,QAAOX,CAAAA,CAAP,EACAA,CADA,EAEAA,CAAe,CAACa,mBAHlB,CAIE,CAGA,GAAIC,CAAAA,CAAG,CAAG,GAAIC,CAAAA,KAAd,CACAD,CAAG,CAACE,gBAAJ,CAAqB,MAArB,CAA6B,UAAW,CACtChB,CAAe,CAACiB,QAAhB,CAA2B,KAAKC,YAAhC,CACAlB,CAAe,CAACmB,SAAhB,CAA4B,KAAKC,aAAjC,CAQAC,CAAoB,CAClBX,CADkB,CAElBnB,CAFkB,CAGlBC,CAHkB,CAIlBC,CAJkB,CAKlBC,CALkB,CAMlBC,CANkB,CAOlBC,CAPkB,CAQlBC,CARkB,CASlBC,CATkB,CAUlBC,CAVkB,CAWlBC,CAXkB,CAarB,CAvBD,EAwBAc,CAAG,CAACQ,GAAJ,CAAUtB,CAAe,CAACa,mBAC3B,CAjCD,IAiCO,CACLQ,CAAoB,CAClBX,CADkB,CAElBnB,CAFkB,CAGlBC,CAHkB,CAIlBC,CAJkB,CAKlBC,CALkB,CAMlBC,CANkB,CAOlBC,CAPkB,CAQlBC,CARkB,CASlBC,CATkB,CAUlBC,CAVkB,CAWlBC,CAXkB,CAarB,CACF,CAvDD,CAwDD,CAnGQ,CAqGX,CAEA,QAASqB,CAAAA,CAAT,CACEZ,CADF,CAEElB,CAFF,CAGEC,CAHF,CAIEC,CAJF,CAKEC,CALF,CAMEC,CANF,CAOEC,CAPF,CAQEC,CARF,CASEC,CATF,CAUEC,CAVF,CAWEC,CAXF,CAYE,CAIAuB,CAAU,IAAV,CAJA,GAMIC,CAAAA,CAAe,CAAG,IANtB,CAOIC,CAAe,GAPnB,CAQIC,CAAW,CAAG,EARlB,CAUA,GAAI1B,CAAJ,CAAqB,CACnB,GAAIA,CAAe,CAACa,mBAApB,CAAyC,CAEvC,GAAIc,CAAAA,EAAiB,CAAG3C,CAAE,CAAC4C,IAAH,CAAQC,eAAR,CACtB7B,CAAe,CAAC8B,IADM,CAEtB,WAFsB,aAAxB,CAKA,GAAI,CAAC9B,CAAe,CAAC+B,UAArB,CAAiC,IAE3BC,CAAAA,CAAU,CAAGL,EAAiB,CAAC,CAAD,CAAjB,CAAuBA,EAAiB,CAAC,CAAD,CAF1B,CAG3BM,CAAW,CAAG,CAACN,EAAiB,CAAC,CAAD,CAAjB,CAAuBA,EAAiB,CAAC,CAAD,CAAzC,EAAgD,CAHnC,CAI3BO,CAAY,CAAG,CAACP,EAAiB,CAAC,CAAD,CAAjB,CAAuBA,EAAiB,CAAC,CAAD,CAAzC,EAAgD,CAJpC,CAK3BQ,CAAY,CAAGC,IAAI,CAACC,KAAL,CAAWL,CAAU,CAAGhC,CAAe,CAACmB,SAAxC,CALY,CAM3BmB,CAAQ,CAAGF,IAAI,CAACC,KAAL,CAAWrC,CAAe,CAACiB,QAAhB,CAA2BkB,CAAtC,CANgB,CAO3BI,CAAS,CAAGH,IAAI,CAACC,KAAL,CAAWrC,CAAe,CAACmB,SAAhB,CAA4BgB,CAAvC,CAPe,CAQ/BR,EAAiB,CAAG,CAClBM,CAAW,CAAGK,CAAQ,CAAG,CADP,CAElBJ,CAAY,CAAGK,CAAS,CAAG,CAFT,CAGlBN,CAAW,CAAGK,CAAQ,CAAG,CAHP,CAIlBJ,CAAY,CAAGK,CAAS,CAAG,CAJT,CAApB,CAMAb,CAAW,CAAG,CACf,CACDF,CAAe,CAAG,GAAIxC,CAAAA,CAAE,CAACwD,KAAH,CAASzB,KAAb,CAAmB,CACnC0B,KAAK,CAAEzC,CAAe,CAAC0C,SADY,CAEnCC,IAAI,CAAE3C,CAAe,CAAC0C,SAFa,CAGnCE,IAAI,CAAE5C,CAAe,CAAC6C,SAHa,CAInCC,MAAM,CAAE,GAAI9D,CAAAA,CAAE,CAAC8D,MAAH,CAAUC,WAAd,CAA0B,CAChChE,GAAG,CAAEiB,CAAe,CAACa,mBADW,CAEhCmC,WAAW,CAAErB,EAFmB,CAA1B,CAJ2B,CAQnCsB,OAAO,CAAE,CAR0B,CAAnB,CAUnB,CAjCD,IAiCO,IAAIjD,CAAe,CAACkD,MAApB,CAA4B,CAEjC,GAAIC,CAAAA,EAAO,CAAG,CACZL,MAAM,CAAE,GAAI9D,CAAAA,CAAE,CAAC8D,MAAH,CAAUM,OAAd,CAAsB,CAC5BrE,GAAG,CAAEiB,CAAe,CAACkD,MADO,CAE5BG,MAAM,CAAErD,CAAe,CAACsD,SAFI,CAAtB,CADI,CAKZV,IAAI,CAAE5C,CAAe,CAAC6C,SALV,CAMZJ,KAAK,CAAEzC,CAAe,CAAC0C,SANX,CAOZC,IAAI,CAAE3C,CAAe,CAAC0C,SAPV,CAAd,CASA,GACE1C,CAAe,CAAC8B,IAAhB,CAAqB,CAArB,GACA9B,CAAe,CAAC8B,IAAhB,CAAqB,CAArB,CADA,EAEA9B,CAAe,CAAC8B,IAAhB,CAAqB,CAArB,CAFA,EAGA9B,CAAe,CAAC8B,IAAhB,CAAqB,CAArB,CAJF,CAKE,CACA,GAAIyB,CAAAA,EAAe,CAAGvE,CAAE,CAAC4C,IAAH,CAAQC,eAAR,CACpB7B,CAAe,CAAC8B,IADI,CAEpB,WAFoB,aAAtB,CAKAqB,EAAO,CAACK,MAAR,CAAiBD,EAClB,CACD/B,CAAe,CAAG,GAAIxC,CAAAA,CAAE,CAACwD,KAAH,CAASiB,IAAb,CAAkBN,EAAlB,CACnB,CAED1B,CAAe,CAAGzB,CAAe,CAAC+B,UACnC,CACD,GAAI,KAAAN,CAAJ,CAA+B,CAE7BhC,CAAiB,GAAjB,CACAX,CAAC,CAAC,aAAD,CAAD,CAAiB4E,IAAjB,EACD,CA7ED,GA+EIC,CAAAA,CAAY,CAAG5E,CAAG,CAAC6E,QAAJ,CAAa,cAAb,CAA6B,cAA7B,CA/EnB,CAgFIC,CAAU,CAAG9E,CAAG,CAAC6E,QAAJ,CAAa,cAAb,CAA6B,cAA7B,CAhFjB,CAiFIE,CAAS,CAAG/E,CAAG,CAAC6E,QAAJ,CAAa,aAAb,CAA4B,cAA5B,CAjFhB,CAkFIG,CAAmB,CAAG,EAlF1B,CAmFIC,CAnFJ,CAoFIC,CAAQ,CAAG,EApFf,CAqFIC,CAAe,CAAG,EArFtB,CAsFIC,CAAwB,GAtF5B,CAuFIC,CAA4B,GAvFhC,CAwFIC,CAAsB,GAxF1B,CAyFIC,CAAM,GAzFV,CA0FIC,CAAY,GA1FhB,CA2FIC,CAAS,GA3Fb,CA4FIC,CAAU,GA5Fd,CA6FIC,CA7FJ,CA8FIC,EAAQ,CAAG,CA9Ff,CAgGIC,EAAI,CAAG,GAAI5F,CAAAA,CAAE,CAAC6F,KAAH,CAASC,IAAb,CAAkB,CAC3BC,SAAS,CAAE,QADgB,CAE3BC,KAAK,CAAE,GAFoB,CAG3BC,IAAI,CAAE,GAAIjG,CAAAA,CAAE,CAAC6F,KAAH,CAASK,IAAb,CAAkB,CACtBC,KAAK,CAAE,SADe,CAAlB,CAHqB,CAM3BC,MAAM,CAAE,GAAIpG,CAAAA,CAAE,CAAC6F,KAAH,CAASQ,MAAb,CAAoB,CAC1BF,KAAK,CAAE,SADmB,CAE1BG,KAAK,CAAE,GAFmB,CAApB,CANmB,CAAlB,CAhGX,CA2GIC,EAAU,CAAG,GAAIvG,CAAAA,CAAE,CAAC6F,KAAH,CAASC,IAAb,CAAkB,CACjCC,SAAS,CAAE,QADsB,CAEjCC,KAAK,CAAE,GAF0B,CAGjCC,IAAI,CAAE,GAAIjG,CAAAA,CAAE,CAAC6F,KAAH,CAASK,IAAb,CAAkB,CACtBC,KAAK,CAAE,MADe,CAAlB,CAH2B,CAMjCC,MAAM,CAAE,GAAIpG,CAAAA,CAAE,CAAC6F,KAAH,CAASQ,MAAb,CAAoB,CAC1BF,KAAK,CAAE,SADmB,CAE1BG,KAAK,CAAE,GAFmB,CAApB,CANyB,CAAlB,CA3GjB,CAsHIE,EAAiB,CAAG,GAAIxG,CAAAA,CAAE,CAAC6F,KAAH,CAASY,KAAb,CAAmB,CACzCC,KAAK,CAAE,GAAI1G,CAAAA,CAAE,CAAC6F,KAAH,CAASc,IAAb,CAAkB,CACvBC,MAAM,CAAE,CAAC,EAAD,CAAM,CAAN,CADe,CAEvB3C,OAAO,CAAE,CAFc,CAGvB+B,KAAK,CAAE,EAHgB,CAIvB1D,GAAG,CAAEqC,CAJkB,CAAlB,CADkC,CAOzCiB,IAAI,CAAEA,EAPmC,CAQzCiB,MAAM,CAAE,UARiC,CAAnB,CAtHxB,CAgIIC,EAAc,CAAG,GAAI9G,CAAAA,CAAE,CAAC6F,KAAH,CAASY,KAAb,CAAmB,CACtCC,KAAK,CAAE,GAAI1G,CAAAA,CAAE,CAAC6F,KAAH,CAASc,IAAb,CAAkB,CACvBC,MAAM,CAAE,CAAC,EAAD,CAAM,CAAN,CADe,CAEvB3C,OAAO,CAAE,CAFc,CAGvB+B,KAAK,CAAE,EAHgB,CAIvB1D,GAAG,CAAEuC,CAJkB,CAAlB,CAD+B,CAOtCe,IAAI,CAAEA,EAPgC,CAQtCiB,MAAM,CAAE,UAR8B,CAAnB,CAhIrB,CA0IIE,EAAuB,CAAG,GAAI/G,CAAAA,CAAE,CAAC6F,KAAH,CAASY,KAAb,CAAmB,CAC/CC,KAAK,CAAE,GAAI1G,CAAAA,CAAE,CAAC6F,KAAH,CAASc,IAAb,CAAkB,CACvBC,MAAM,CAAE,CAAC,EAAD,CAAM,CAAN,CADe,CAEvB3C,OAAO,CAAE,CAFc,CAGvB+B,KAAK,CAAE,GAHgB,CAIvB1D,GAAG,CAAEqC,CAJkB,CAAlB,CADwC,CAO/CiB,IAAI,CAAEW,EAPyC,CAQ/CM,MAAM,CAAE,UARuC,CAAnB,CA1I9B,CAoJIG,EAAoB,CAAG,GAAIhH,CAAAA,CAAE,CAAC6F,KAAH,CAASY,KAAb,CAAmB,CAC5CC,KAAK,CAAE,GAAI1G,CAAAA,CAAE,CAAC6F,KAAH,CAASc,IAAb,CAAkB,CACvBC,MAAM,CAAE,CAAC,EAAD,CAAM,CAAN,CADe,CAEvB3C,OAAO,CAAE,CAFc,CAGvB+B,KAAK,CAAE,GAHgB,CAIvB1D,GAAG,CAAEuC,CAJkB,CAAlB,CADqC,CAO5Ce,IAAI,CAAEW,EAPsC,CAQ5CM,MAAM,CAAE,UARoC,CAAnB,CApJ3B,CA8JII,EAAoB,CAAG,GAAIjH,CAAAA,CAAE,CAAC6F,KAAH,CAASY,KAAb,CAAmB,CAC5CC,KAAK,CAAE,GAAI1G,CAAAA,CAAE,CAAC6F,KAAH,CAASqB,MAAb,CAAoB,CACzBC,MAAM,CAAE,CADiB,CAEzBlB,IAAI,CAAE,GAAIjG,CAAAA,CAAE,CAAC6F,KAAH,CAASK,IAAb,CAAkB,CACtBC,KAAK,CAAE,CAAC,CAAD,CAAI,CAAJ,CAAO,CAAP,CAAU,CAAV,CADe,CAAlB,CAFmB,CAKzBC,MAAM,CAAE,GAAIpG,CAAAA,CAAE,CAAC6F,KAAH,CAASQ,MAAb,CAAoB,CAC1BF,KAAK,CAAE,CAAC,GAAD,CAAM,GAAN,CAAW,GAAX,CAAgB,CAAhB,CADmB,CAE1BG,KAAK,CAAE,CAFmB,CAApB,CALiB,CAApB,CADqC,CAAnB,CA9J3B,CA0KIc,EAAoB,CAAG,GAAIpH,CAAAA,CAAE,CAAC6F,KAAH,CAASY,KAAb,CAAmB,CAC5CR,IAAI,CAAE,GAAIjG,CAAAA,CAAE,CAAC6F,KAAH,CAASK,IAAb,CAAkB,CACtBC,KAAK,CAAE,CAAC,GAAD,CAAM,GAAN,CAAW,GAAX,CAAgB,EAAhB,CADe,CAAlB,CADsC,CAI5CC,MAAM,CAAE,GAAIpG,CAAAA,CAAE,CAAC6F,KAAH,CAASQ,MAAb,CAAoB,CAC1BF,KAAK,CAAE,CAAC,CAAD,CAAI,CAAJ,CAAO,CAAP,CAAU,EAAV,CADmB,CAE1BG,KAAK,CAAE,CAFmB,CAApB,CAJoC,CAQ5CO,MAAM,CAAE,CAAC,CARmC,CAAnB,CA1K3B,CAoLIQ,EAAkB,CAAG,GAAIrH,CAAAA,CAAE,CAAC6F,KAAH,CAASY,KAAb,CAAmB,CAC1CC,KAAK,CAAE,GAAI1G,CAAAA,CAAE,CAAC6F,KAAH,CAASc,IAAb,CAAkB,CACvBC,MAAM,CAAE,CAAC,EAAD,CAAM,EAAN,CADe,CAEvB3C,OAAO,CAAE,CAFc,CAGvB+B,KAAK,CAAE,CAHgB,CAIvB1D,GAAG,CAAEwC,CAJkB,CAAlB,CADmC,CAAnB,CApLzB,CA6LIwC,EAAM,CAAG,EA7Lb,CA8LIC,EAAa,CAAG,GAAIvH,CAAAA,CAAE,CAACwH,MAAH,CAAUC,OA9LlC,CA+LI3D,EAAM,CAAG,GAAI9D,CAAAA,CAAE,CAAC8D,MAAH,CAAU4D,MAAd,CAAqB,CAChCC,UAAU,CAAE,WADoB,CAArB,CA/Lb,CAkMIC,EAAa,CAAG,GAAI5H,CAAAA,CAAE,CAACwD,KAAH,CAASkE,MAAb,CAAoB,CACtC5D,MAAM,CAAEA,EAD8B,CAEtC+B,KAAK,CA0HP,SAAwBgC,CAAxB,CAAiC,CAE/B,GAAIC,CAAAA,CAAa,CAAGD,CAAO,CAACE,GAAR,CAAY,eAAZ,CAApB,CACA,GAAsB,CAAlB,GAAAD,CAAJ,CAAyB,IACnB7B,CAAAA,CAAI,CAAG,GAAIjG,CAAAA,CAAE,CAAC6F,KAAH,CAASK,IAAb,CAAkB,CAC3BC,KAAK,CAAE,uBADoB,CAAlB,CADY,CAInBC,CAAM,CAAG,GAAIpG,CAAAA,CAAE,CAAC6F,KAAH,CAASQ,MAAb,CAAoB,CAC/BF,KAAK,CAAE,SADwB,CAE/BG,KAAK,CAAE,IAFwB,CAApB,CAJU,CAQnB0B,CAAM,CAAG,GAAIhI,CAAAA,CAAE,CAAC6F,KAAH,CAASY,KAAb,CAAmB,CAC9BC,KAAK,CAAE,GAAI1G,CAAAA,CAAE,CAAC6F,KAAH,CAASqB,MAAb,CAAoB,CACzBjB,IAAI,CAAEA,CADmB,CAEzBG,MAAM,CAAEA,CAFiB,CAGzBe,MAAM,CAAE,CAHiB,CAApB,CADuB,CAM9BlB,IAAI,CAAEA,CANwB,CAO9BG,MAAM,CAAEA,CAPsB,CAQ9BR,IAAI,CAAE,GAAI5F,CAAAA,CAAE,CAAC6F,KAAH,CAASC,IAAb,CAAkB,CACtBF,IAAI,CAAEnE,CAAO,cADS,CAEtBsE,SAAS,CAAE,QAFW,CAGtBE,IAAI,CAAE,GAAIjG,CAAAA,CAAE,CAAC6F,KAAH,CAASK,IAAb,CAAkB,CACtBC,KAAK,CAAE,kBADe,CAAlB,CAHgB,CAMtBC,MAAM,CAAE,GAAIpG,CAAAA,CAAE,CAAC6F,KAAH,CAASQ,MAAb,CAAoB,CAC1BF,KAAK,CAAE,SADmB,CAE1BG,KAAK,CAAE,CAFmB,CAApB,CANc,CAAlB,CARwB,CAAnB,CARU,CA4BvB,MAAO,CAAC0B,CAAD,CACR,CACD,GAAI,CAACH,CAAO,CAACE,GAAR,CAAY,gBAAZ,CAAL,CAAoC,CAElCjB,EAAc,CAACmB,OAAf,GAAyBC,OAAzB,CAAiC,GAAKJ,CAAtC,EACA,MAAO,CAAChB,EAAD,CACR,CAEDN,EAAiB,CAACyB,OAAlB,GAA4BC,OAA5B,CAAoC,GAAKJ,CAAzC,EACA,MAAO,CAACtB,EAAD,CACR,CArKuC,CAApB,CAlMpB,CAsMI2B,EAAW,CAAG,GAAInI,CAAAA,CAAE,CAACwD,KAAH,CAASiB,IAAb,CAAkB,CAClC2D,OAAO,GAD2B,CAElCtE,MAAM,CAAE,GAAI9D,CAAAA,CAAE,CAAC8D,MAAH,CAAUuE,QAAd,CAAuB,CAC7BhH,GAAG,CAAE,kEADwB,CAE7BiH,UAAU,CAAE,kBAFiB,CAG7BC,OAAO,CAAE,EAHoB,CAAvB,CAF0B,CAAlB,CAtMlB,CAiNAJ,EAAW,CAACK,GAAZ,CAAgB,MAAhB,CAAwB/G,CAAO,WAA/B,EACA,GAAIgH,CAAAA,EAAS,CAAG,GAAIzI,CAAAA,CAAE,CAACwD,KAAH,CAASiB,IAAb,CAAkB,CAChCX,MAAM,CAAE,GAAI9D,CAAAA,CAAE,CAAC8D,MAAH,CAAU4E,GADU,CAAlB,CAAhB,CAGAD,EAAS,CAACD,GAAV,CAAc,MAAd,CAAsB/G,CAAO,SAA7B,EArNA,GAuNIkH,CAAAA,EAAU,CAAG,EAvNjB,CAwNIC,EAAa,CAAG,EAxNpB,CAyNA,GAAI,CAAC5H,CAAD,EAAoB,KAAAA,CAAe,CAAC6H,QAAxC,CAA4D,CAC1DF,EAAU,CAAG,CAACR,EAAD,CAAcM,EAAd,CACd,CACD,GAAIjG,CAAJ,CAAqB,CACnB,GAAiC,SAA7B,EAAAxB,CAAe,CAAC6C,SAApB,CAA4C,CAC1C8E,EAAU,CAACG,IAAX,CAAgBtG,CAAhB,CACD,CAFD,IAEO,CACLoG,EAAa,CAACE,IAAd,CAAmBtG,CAAnB,CACD,CACF,CAlOD,GAmOIuG,CAAAA,EAAU,CAAG,GAAI/I,CAAAA,CAAE,CAACwD,KAAH,CAASwF,KAAb,CAAmB,CAAE1B,MAAM,CAAEqB,EAAV,CAAnB,CAnOjB,CAqOIM,EAAQ,CAAG,IArOf,CAsOAF,EAAU,CAACG,SAAX,GAAuBC,OAAvB,CAA+B,SAAA3F,CAAK,CAAI,CACtCA,CAAK,CAAC4F,UAAN,KACAH,EAAQ,CAAGzF,CACZ,CAHD,EAIAyF,EAAQ,CAACG,UAAT,KA1OA,GA4OIC,CAAAA,EAAI,CAAG,GAAIrJ,CAAAA,CAAE,CAACsJ,IAAP,CAAY,CACrBC,MAAM,CAAE,CAAC,CAAD,CAAI,CAAJ,CADa,CAErBC,IAAI,CAAE,CAFe,CAGrBC,OAAO,CAAE,CAHY,CAAZ,CA5OX,CAiPIC,EAAM,CAAG,GAAI1J,CAAAA,CAAE,CAAC2J,WAAH,CAAeC,MAAnB,CAA0B,CACrCtC,MAAM,CAAE,CAACM,EAAD,CAD6B,CAErC/B,KAAK,CAqHP,SAA+BgC,CAA/B,CAAwC,CACtC,GAAIC,CAAAA,CAAa,CAAGD,CAAO,CAACE,GAAR,CAAY,eAAZ,CAApB,CACA,GAAI,CAACF,CAAO,CAACE,GAAR,CAAY,gBAAZ,CAAL,CAAoC,CAClCf,EAAoB,CAACiB,OAArB,GAA+BC,OAA/B,CAAuC,GAAKJ,CAA5C,EACA,MAAO,CAACd,EAAD,CACR,CACDD,EAAuB,CAACkB,OAAxB,GAAkCC,OAAlC,CAA0C,GAAKJ,CAA/C,EACA,MAAO,CAACf,EAAD,CACR,CA/HsC,CAGrC8C,MAAM,CAAE,gBAAAhC,CAAO,CAAI,CACjB,GAAqC,CAAjC,GAAAA,CAAO,CAACE,GAAR,CAAY,eAAZ,CAAJ,CAAwC,CACtC,QACD,CACD,QACD,CARoC,CAA1B,CAjPb,CA2PI+B,EAAe,CAAG,GAAI9J,CAAAA,CAAE,CAAC+J,OA3P7B,CA4PAD,EAAe,CAACE,aAAhB,CAA8B,CAAErG,IAAI,CAAE,eAAR,CAA9B,EACAmG,EAAe,CAACG,QAAhB,CAAyB7C,EAAzB,EACA,GAAI8C,CAAAA,EAAe,CAAG,GAAIlK,CAAAA,CAAE,CAAC+J,OAA7B,CACAG,EAAe,CAACF,aAAhB,CAA8B,CAAErG,IAAI,CAAE,eAAR,CAA9B,EACAuG,EAAe,CAACD,QAAhB,CAAyBhD,EAAzB,EAhQA,GAiQIkD,CAAAA,EAAY,CAAG,GAAInK,CAAAA,CAAE,CAACwD,KAAH,CAASkE,MAAb,CAAoB,CACrC5D,MAAM,CAAE,GAAI9D,CAAAA,CAAE,CAAC8D,MAAH,CAAU4D,MAAd,CAAqB,CAC3B0C,QAAQ,CAAE,CAACN,EAAD,CAAkBI,EAAlB,CADiB,CAArB,CAD6B,CAApB,CAjQnB,CAsQIG,EAAa,CAAG,GAAIrK,CAAAA,CAAE,CAAC+J,OAtQ3B,CAuQAM,EAAa,CAACC,WAAd,CAA0B,IAA1B,EACAD,EAAa,CAACJ,QAAd,CAAuB5C,EAAvB,EACA,GAAIkD,CAAAA,EAAY,CAAG,GAAIvK,CAAAA,CAAE,CAACwD,KAAH,CAASkE,MAAb,CAAoB,CACrC5D,MAAM,CAAE,GAAI9D,CAAAA,CAAE,CAAC8D,MAAH,CAAU4D,MAAd,CAAqB,CAC3B0C,QAAQ,CAAE,CAACC,EAAD,CADiB,CAArB,CAD6B,CAApB,CAAnB,CAKA/C,EAAM,CAACwB,IAAP,CAAYC,EAAZ,EACAzB,EAAM,CAAGA,EAAM,CAACkD,MAAP,CAAc5B,EAAd,CAAT,CACAtB,EAAM,CAAGA,EAAM,CAACkD,MAAP,CAAc,CAAC5C,EAAD,CAAgBuC,EAAhB,CAA8BI,EAA9B,CAAd,CAAT,CAhRA,GAkRIf,CAAAA,EAAI,CAAG,GAAIxJ,CAAAA,CAAE,CAACyK,OAAH,CAAWC,IAAf,CAAoB,CAC7BC,MAAM,CAAE,YADqB,CAE7BC,SAAS,CAAE,aAFkB,CAApB,CAlRX,CAsRIzJ,EAAG,CAAG,GAAInB,CAAAA,CAAE,CAAC6K,GAAP,CAAW,CACnBvD,MAAM,CAAEA,EADW,CAEnBwD,QAAQ,CAAE,CAACtB,EAAD,CAFS,CAGnBmB,MAAM,CAAE,SAHW,CAInBtB,IAAI,CAAEA,EAJa,CAKnB0B,uBAAuB,GALJ,CAMnBC,yBAAyB,GANN,CAAX,CAtRV,CA8RA7J,EAAG,CAAC8J,cAAJ,CAAmBvB,EAAnB,EAEAwB,CAAY,OAAZ,CAEAlG,CAAQ,CAAGmG,WAAW,CAAC,UAAM,CAC3BD,CAAY,OACb,CAFqB,CAEnBrK,CAFmB,CAAtB,CAKA,CA2bA,SAAgCkI,CAAhC,CAA4C,CAC1CA,CAAU,CAACG,SAAX,GAAuBC,OAAvB,CAA+B,SAAA3F,CAAK,CAAI,IAClC4H,CAAAA,CAAI,CAAGtL,CAAC,CAAC,UAAD,CAAa,CACvB8D,IAAI,CAAE,QADiB,CAEvByH,KAAK,CAAE,oDAFgB,CAAb,CAAD,CAGRC,KAHQ,CAGF,UAAM,CACbvC,CAAU,CAACG,SAAX,GAAuBC,OAAvB,CAA+B,SAAAoC,CAAC,CAAI,CAClC,GAAIA,CAAC,GAAK/H,CAAV,CAAiB,CACf+H,CAAC,CAACnC,UAAF,IACD,CAFD,IAEO,CACLmC,CAAC,CAACnC,UAAF,IACD,CACF,CAND,CAOD,CAXU,CAD2B,CAalCoC,CAAW,CAAG1L,CAAC,CAAC,OAAD,CAAU,CAC3B8F,IAAI,CAAEpC,CAAK,CAACuE,GAAN,CAAU,MAAV,CADqB,CAE3BsD,KAAK,CAAE,eAAiB7H,CAAK,CAACiI,UAAN,GAAqB,EAArB,CAA0B,WAA3C,CAFoB,CAAV,CAAD,CAGfC,MAHe,CAGR5L,CAAC,CAAC,gCAAD,CAHO,CAboB,CAiBtCsL,CAAI,CAACM,MAAL,CAAYF,CAAZ,EACAhI,CAAK,CAACmI,EAAN,CAAS,gBAAT,CAA2B,UAAM,CAC/B7L,CAAC,CAAC0L,CAAD,CAAD,CAAeI,WAAf,CAA2B,WAA3B,CACD,CAFD,EAGA9L,CAAC,CAAC,aAAD,CAAD,CAAiB+L,OAAjB,CAAyBT,CAAzB,CACD,CAtBD,CAuBD,CAndD,EAAuBrC,EAAvB,EACAH,EAAa,CAACO,OAAd,CAAsB,SAAA2C,CAAO,CAAI,CAC/BC,CAAiB,CAACD,CAAD,CAClB,CAFD,EAGA,GAAIhL,CAAQ,EAAIC,CAAhB,CAAsB,CACpB,GAAIiL,CAAAA,EAAe,CAAG5L,CAAO,CAAC6L,WAAR,CACpB9K,EADoB,CAEpBZ,CAFoB,CAGpBC,CAHoB,CAIpBiB,CAJoB,CAKpBV,CALoB,CAMpB,YANoB,CAAtB,CAQAiL,EAAe,CAACxD,GAAhB,CAAoB,MAApB,CAA4BwD,EAAe,CAACjE,GAAhB,CAAoB,OAApB,CAA5B,EAToB,GAWhBmE,CAAAA,EAAU,CAAGF,EAAe,CAAC9C,SAAhB,GAA4BiD,IAA5B,CAAiC,CAAjC,CAXG,CAYhBC,EAAS,CAAGF,EAAU,CAACnE,GAAX,CAAe,OAAf,CAZI,CAahBsE,EAAU,CAAGD,EAAS,CAACE,SAAV,CAAoBF,EAAS,CAACG,OAAV,CAAkB,MAAlB,EAA4B,CAAhD,CAbG,CAcpBL,EAAU,CAAC1D,GAAX,CAAe,MAAf,CAAuB6D,EAAvB,EACAH,EAAU,CAAC9C,UAAX,KACA2C,CAAiB,CAACG,EAAD,CAClB,CAqDD,QAASM,CAAAA,CAAT,EAA4B,CAC1B,GAAI/L,CAAiB,EAAI,CAAC4J,EAAa,CAACoC,WAAd,EAA1B,CAAuD,CACrDC,CAAK,CAACjL,CAAO,QAAR,CACN,CAFD,IAEO,CACLyJ,CAAY,OACb,CACF,CACD,QAASyB,CAAAA,CAAT,EAAyB,CACvB,GAAMC,CAAAA,CAAQ,CAAGC,EAAW,CAACC,WAAZ,EAAjB,CACAC,CAAM,CAAC5L,EAAD,CAAMyL,CAAN,CACP,CACD,QAASG,CAAAA,CAAT,CAAgB5L,CAAhB,CAAqB6L,CAArB,CAA4BxI,CAA5B,CAAoC,IAE9B6E,CAAAA,CAAI,CAAGlI,CAAG,CAAC8L,OAAJ,EAFuB,CAGlC,GAAIzI,CAAJ,CAAY,CACV6E,CAAI,CAAC6D,GAAL,CAAS1I,CAAT,CAAiB,CACf2I,QAAQ,IADO,CAAjB,CAGD,CAJD,IAIO,CACL9D,CAAI,CAAC+D,OAAL,CAAa,CACX5D,IAAI,CAAE9G,CADK,CAEX6G,MAAM,CAAEyD,CAFG,CAGXG,QAAQ,IAHG,CAAb,CAKD,CACF,CAUD,QAASjC,CAAAA,CAAT,CAAsBmC,CAAtB,CAAgCC,CAAhC,CAA4CC,CAA5C,CAA8DC,CAA9D,CAAsE,IAEhEZ,CAAAA,CAFgE,CAGhEa,CAHgE,CAIhEC,CAJgE,CAKhEC,CALgE,CAOpE,GAAIlN,CAAJ,CAAuB,CACrBiN,CAAW,CAAGrD,EAAa,CAACoC,WAAd,EACf,CAFD,IAEO,CACLiB,CAAW,CAAGxD,EAAe,CAACuC,WAAhB,EACf,CACD,GAAIiB,CAAJ,CAAiB,CACfD,CAAe,CAAGlG,EAAa,CAACqG,mBAAd,CAAkCF,CAAlC,CAA+C,CAC/DG,cAAc,CAAE,WAD+C,CAE/DC,iBAAiB,CAAE,WAF4C,CAA/C,CAInB,CACD,GAAIP,CAAJ,CAAsB,CAEpBhL,CAAU,IAAV,CACAoL,CAAQ,CAAGJ,CACZ,CACD,GAAIF,CAAJ,CAAc,CACZT,CAAQ,CAAGa,CAAX,CACAlL,CAAU,IAGX,CACD,GAAIwL,CAAAA,CAAO,CAAG9N,CAAI,CAAC+N,IAAL,CAAU,CACtB,CACEC,UAAU,CAAE,gCADd,CAEEC,IAAI,CAAE,CACJC,YAAY,CAAE,CACZ3N,cAAc,CAAEA,CADJ,CAEZ4N,gBAAgB,CAAEzN,CAFN,CAGZ0N,aAAa,CAAEzN,CAHH,CAIZH,iBAAiB,CAAEA,CAJP,CAKZC,SAAS,CAAEA,CALC,CAMZ4M,UAAU,CAAEA,CANA,CAOZD,QAAQ,CAAET,CAPE,CAQZa,eAAe,CACb3M,CAAQ,EAAI,CAACL,CAAb,CAAiCgN,CAAjC,OATU,CAUZF,gBAAgB,CAAEI,CAVN,CAWZlI,UAAU,CAAEA,CAXA,CAYZ+H,MAAM,CAAEA,CAZI,CADV,CAFR,CADsB,CAAV,CAAd,CAqBAO,CAAO,CAAC,CAAD,CAAP,CACGvM,IADH,CACQ,SAAA8M,CAAQ,CAAI,CAEhB7I,CAAU,CAAG6I,CAAQ,CAAC7I,UAAtB,CACAF,CAAY,CAAG+I,CAAQ,CAAC/I,YAAxB,CACAC,CAAS,CAAG8I,CAAQ,CAAC9I,SAArB,CACAjD,CAAU,IAAV,CAIA,GAAI8K,CAAQ,EAAIE,CAAhB,CAAkC,CAChC,GAAIe,CAAQ,CAACC,MAAT,EAAmB/I,CAAvB,CAAkC,CAEjC,CACF,CACD,GAAI8I,CAAQ,CAACE,UAAb,CAAyB,CACvB1O,CAAC,CAAC,aAAD,CAAD,CAAiB2O,IAAjB,EACD,CAFD,IAEO,CACL3O,CAAC,CAAC,aAAD,CAAD,CAAiB4E,IAAjB,EACD,CAED,GAAIjE,CAAiB,EAAI6N,CAAQ,CAAC7N,iBAAlC,CAAqD,CACnDA,CAAiB,CAAG6N,CAAQ,CAAC7N,iBAA7B,CACA,GAAI,CAACA,CAAL,CAAwB,CACtB4J,EAAa,CAACC,WAAd,CAA0B,IAA1B,CACD,CACF,CAED,GAAI5J,CAAS,EAAI4N,CAAQ,CAAC5N,SAA1B,CAAqC,CACnCA,CAAS,CAAG4N,CAAQ,CAAC5N,SACtB,CACD,GACEC,CAAoB,GAAK2N,CAAQ,CAACF,gBAAlC,EACAxN,CAAiB,GAAK0N,CAAQ,CAACD,aAD/B,EAEAf,CAFA,EAGA,CAAC9H,CAJH,CAKE,CACA7E,CAAoB,CAAG2N,CAAQ,CAACF,gBAAhC,CACAxN,CAAiB,CAAG0N,CAAQ,CAACD,aAA7B,CACA,GAAqC,CAAjC,CAAAC,CAAQ,CAACI,cAAT,CAAwB9M,MAA5B,CAAwC,CACtCsD,CAAe,CAAGoJ,CAAQ,CAACI,cAA3B,CACAvJ,CAAwB,GACzB,CAED,GAAImJ,CAAQ,CAACK,QAAT,EAAqBL,CAAQ,CAACM,cAAlC,CAAkD,CAChD9K,EAAM,CAAC+K,KAAP,GACA,GAAIP,CAAQ,CAACM,cAAb,CAA6B,CAC3B9K,EAAM,CAACgL,WAAP,CACEvH,EAAa,CAACwH,YAAd,CAA2BT,CAAQ,CAACM,cAApC,CAAoD,CAClDf,cAAc,CAAE,WADkC,CAElDC,iBAAiB,CAAE,WAF+B,CAApD,CADF,CAMD,CACD,GAAwC,CAApC,CAAAQ,CAAQ,CAACK,QAAT,CAAkBvE,QAAlB,CAA2BxI,MAA/B,CAA2C,CACzCkC,EAAM,CAACgL,WAAP,CACEvH,EAAa,CAACwH,YAAd,CAA2BT,CAAQ,CAACK,QAApC,CAA8C,CAC5Cd,cAAc,CAAE,WAD4B,CAE5CC,iBAAiB,CAAE,WAFyB,CAA9C,CADF,CAMD,CACF,CAED,GAAIQ,CAAQ,CAACvJ,mBAAb,CAAkC,CAChCA,CAAmB,CAAGuJ,CAAQ,CAACvJ,mBAA/B,CACAK,CAA4B,GAA5B,CAEA,GAAqC,EAAjC,GAAAL,CAAmB,CAACiK,QAAxB,CAAyC,CACvC3J,CAAsB,GAAtB,CACAvF,CAAC,CAAC,mBAAD,CAAD,CAAuB4E,IAAvB,GACA5E,CAAC,CAAC,kBAAD,CAAD,CAAsB2O,IAAtB,EACD,CAJD,IAIO,IAAI,CAAC1J,CAAmB,CAACkK,cAAzB,CAAyC,CAC9CnP,CAAC,CAAC,mBAAD,CAAD,CAAuB4E,IAAvB,GACA5E,CAAC,CAAC,kBAAD,CAAD,CAAsB2O,IAAtB,EACD,CAHM,IAGA,CACL3O,CAAC,CAAC,mBAAD,CAAD,CAAuB2O,IAAvB,GACA3O,CAAC,CAAC,kBAAD,CAAD,CAAsB4E,IAAtB,EACD,CACF,CAED,GAAI4J,CAAQ,CAACM,cAAT,EAA2BtB,CAA/B,CAA2C,CACzChI,CAAM,GACP,CAED4J,CAAuB,GACvBC,CAAiB,GACjBC,CAAY,GACZC,CAAoB,EACrB,CACD,GAA8B,CAA1B,CAAAf,CAAQ,CAACgB,OAAT,CAAiB1N,MAArB,CAAiC,CAC/BqD,CAAQ,CAACkE,OAAT,CAAiB,UAAM,CAEtB,CAFD,EAGAmF,CAAQ,CAACgB,OAAT,CAAiBnG,OAAjB,CAAyB,SAAAoG,CAAG,CAAI,CAC9BtK,CAAQ,CAAC6D,IAAT,CAAcyG,CAAd,CAED,CAHD,CAKD,CACD,GAAI,CAAChK,CAAL,CAAmB,CACjBzF,CAAC,CAAC,YAAD,CAAD,CAAgB4E,IAAhB,EACD,CACD,GAAIa,CAAY,EAAI,CAACC,CAArB,CAAgC,CAC9B1F,CAAC,CAAC,mBAAD,CAAD,CAAuB4E,IAAvB,GACA5E,CAAC,CAAC,kBAAD,CAAD,CAAsB4E,IAAtB,GACA5E,CAAC,CAAC,YAAD,CAAD,CAAgB2O,IAAhB,GACApE,EAAa,CAACC,WAAd,CAA0B,IAA1B,EACA7J,CAAiB,GAAjB,CACA+O,aAAa,CAACxK,CAAD,CAAb,CACAlF,CAAC,CAAC,UAAD,CAAD,CAAc2P,GAAd,CAAkB,SAAlB,CAA6B,KAA7B,CACD,CACF,CAhHH,EAiHGC,IAjHH,CAiHQ,UAAM,CAGVF,aAAa,CAACxK,CAAD,CACd,CArHH,CAsHD,CACD,QAASmK,CAAAA,CAAT,EAA6B,CAC3B,GAAI7J,CAAJ,CAAY,CACV,GAAI8E,CAAAA,CAAQ,CAAGtG,EAAM,CAAC6L,WAAP,EAAf,CACA,GACsB,CAApB,GAAAvF,CAAQ,CAACxI,MAAT,EACAwI,CAAQ,CAAC,CAAD,CAAR,CAAYqC,WAAZ,YAAqCzM,CAAAA,CAAE,CAAC4P,IAAH,CAAQC,KAF/C,CAGE,CACA9C,CAAM,CAAC5L,EAAD,CAAMiJ,CAAQ,CAAC,CAAD,CAAR,CAAYqC,WAAZ,GAA0BqD,cAA1B,EAAN,CACP,CALD,IAKO,CACL/C,CAAM,CAAC5L,EAAD,CAAM,IAAN,CAAY2C,EAAM,CAACiM,SAAP,EAAZ,CACP,CAEDzK,CAAM,GACP,CACF,CACD,QAAS4J,CAAAA,CAAT,EAAmC,CACjC,GAAI9J,CAAJ,CAAkC,CAChCtF,CAAC,CAAC,0BAAD,CAAD,CAA8B8F,IAA9B,CACEnE,CAAO,MAAP,CAAmB,GAAnB,CAAyBsD,CAAmB,CAACpB,IAD/C,EAGA7D,CAAC,CAAC,wBAAD,CAAD,CAA4B8F,IAA5B,CACEb,CAAmB,CAAC6H,QAApB,CAA+B,KAA/B,CAAuC7H,CAAmB,CAACiL,WAD7D,EAJgC,GAQ5BC,CAAAA,CAR4B,CAUhClL,CAAmB,CAACmL,IAApB,CAA2BnL,CAAmB,CAACmL,IAApB,CAAyBC,OAAzB,CACzB,SADyB,CAEzB,gBAFyB,CAA3B,CAIArQ,CAAC,CAAC,0BAAD,CAAD,CAA8BsQ,IAA9B,CAAmCrL,CAAmB,CAACmL,IAAvD,EACA,GAAIG,CAAAA,CAAa,CAAGtL,CAAmB,CAACmL,IAApB,CAAyBC,OAAzB,CAClB,gBADkB,CAElB,EAFkB,CAApB,CAIA,GAAIE,CAAa,CAACzO,MAAd,IAAJ,CAAyC,CACvC9B,CAAC,CAAC,0BAAD,CAAD,CAA8BwQ,QAA9B,MACAL,CAAQ,iLAAR,CAGAnQ,CAAC,CAAC,0BAAD,CAAD,CAA8B4L,MAA9B,CAAqCuE,CAArC,CACD,CAND,IAMO,CACLA,CAAQ,CAAGlL,CAAmB,CAACmL,IAChC,CAEDpQ,CAAC,CAAC,2BAAD,CAAD,CAA+B8F,IAA/B,CAAoCb,CAAmB,CAACpB,IAAxD,EACA7D,CAAC,CAAC,yBAAD,CAAD,CAA6B8F,IAA7B,CACEb,CAAmB,CAAC6H,QAApB,CAA+B,KAA/B,CAAuC7H,CAAmB,CAACiL,WAD7D,EAGAlQ,CAAC,CAAC,2BAAD,CAAD,CAA+BsQ,IAA/B,CAAoCrL,CAAmB,CAACmL,IAAxD,EAEA,GAAqC,EAAjC,GAAAnL,CAAmB,CAACiK,QAAxB,CAAyC,CACvClP,CAAC,CAAC,0BAAD,CAAD,CAA8B4L,MAA9B,CACE,gJAGEjK,CAAO,SAHT,CAIE,MALJ,EAOA3B,CAAC,CAAC,2BAAD,CAAD,CAA+B4L,MAA/B,CACE,gJAGEjK,CAAO,SAHT,CAIE,MALJ,CAOD,CAED3B,CAAC,CAAC,sBAAD,CAAD,CAA0ByQ,QAA1B,CAAmC,MAAnC,EACAnL,CAA4B,GAC7B,CACF,CACD,QAASgK,CAAAA,CAAT,EAAwB,CACtB,GAAI/J,CAAJ,CAA4B,CAE1BN,CAAmB,CAACiK,QAApB,CAA+BjK,CAAmB,CAACiK,QAApB,CAA6BmB,OAA7B,CAC7B,SAD6B,CAE7B,gBAF6B,CAA/B,CAKArQ,CAAC,CAAC,eAAD,CAAD,CAAmBsQ,IAAnB,CACE,WAAarL,CAAmB,CAACiK,QAAjC,CAA4C,WAD9C,EAGA,GAAIwB,CAAAA,CAAO,CAAG,CAAd,CACA1Q,CAAC,CAAC2Q,IAAF,CAAO1L,CAAmB,CAAC2L,OAA3B,CAAoC,SAACrP,CAAD,CAAMsP,CAAN,CAAiB,CACnD,GAAIC,CAAAA,CAAE,CAAG,SAAWJ,CAApB,CAEAG,CAAM,CAACE,UAAP,CAAoBF,CAAM,CAACE,UAAP,CAAkBV,OAAlB,CAClB,SADkB,CAElB,gBAFkB,CAApB,CAKArQ,CAAC,CAAC,eAAD,CAAD,CAAmB4L,MAAnB,CACE,+CACEkF,CADF,CAEE,YAFF,CAGED,CAAM,CAACC,EAHT,oBAMEA,CANF,CAOE,KAPF,CAQED,CAAM,CAACE,UART,CASE,UAVJ,EAYAL,CAAO,EACR,CArBD,EAmCAnL,CAAsB,GACvB,CACF,CACD,QAASgK,CAAAA,CAAT,EAAgC,CAE9B,GAAIlK,CAAJ,CAA8B,CAC5B,GAAI2L,CAAAA,CAAY,CAAGhR,CAAC,CAAC,cAAD,CAApB,CAEAgR,CAAY,CAACV,IAAb,CAAkB,EAAlB,EACAjL,CAAwB,GAAxB,CACA,GAA+B,CAA3B,GAAAD,CAAe,CAACtD,MAApB,CAAkC,CAChC9B,CAAC,CAAC,OAAS2B,CAAO,WAAhB,CAAiC,OAAlC,CAAD,CAA4CsP,QAA5C,CAAqDD,CAArD,CACD,CAFD,IAEO,CAEL5L,CAAe,CAACiE,OAAhB,CAAwB,SAAA6H,CAAO,CAAI,CACjClR,CAAC,CACC,sCACGkR,CAAO,CAACC,OAAR,CACG,8BADH,CAEG,iCAHN,EAIE,qCAJF,CAKED,CAAO,CAACE,MALV,CAME,OAPH,CAAD,CAQEH,QARF,CAQWD,CARX,CASD,CAVD,CAWD,CACF,CACF,CACD,QAAS/E,CAAAA,CAAT,CAA2BvI,CAA3B,CAAkC,IAC5B4H,CAAAA,CAAI,CAAGtL,CAAC,CAAC,UAAD,CAAa,CACvB8D,IAAI,CAAE,QADiB,CAEvByH,KAAK,CAAE,oDAFgB,CAAb,CAAD,CAGRC,KAHQ,CAGF,UAAM,CACb9H,CAAK,CAAC4F,UAAN,CAAiB,CAAC5F,CAAK,CAACiI,UAAN,EAAlB,CACD,CALU,CADqB,CAO5BD,CAAW,CAAG1L,CAAC,CAAC,OAAD,CAAU,CAC3B8F,IAAI,CAAEpC,CAAK,CAACuE,GAAN,CAAU,MAAV,CADqB,CAE3BsD,KAAK,CAAE,eAAiB7H,CAAK,CAACiI,UAAN,GAAqB,EAArB,CAA0B,WAA3C,CAFoB,CAAV,CAAD,CAGfC,MAHe,CAGR5L,CAAC,CAAC,gCAAD,CAHO,CAPc,CAWhCsL,CAAI,CAACM,MAAL,CAAYF,CAAZ,EACAhI,CAAK,CAACmI,EAAN,CAAS,gBAAT,CAA2B,UAAM,CAC/B7L,CAAC,CAAC0L,CAAD,CAAD,CAAeI,WAAf,CAA2B,WAA3B,CACD,CAFD,EAGA9L,CAAC,CAAC,aAAD,CAAD,CAAiB+L,OAAjB,CAAyBT,CAAzB,CACD,CA+BD,GAAIyB,CAAAA,EAAW,CAAG,GAAI7M,CAAAA,CAAE,CAACmR,WAAP,CACuB,CACrCxJ,UAAU,CAAE0B,EAAI,CAAC+H,aAAL,EADyB,CAErCC,eAAe,CAAE,CACfC,kBAAkB,GADH,CAEfC,UAAU,CAAE,CAFG,CAGfC,OAAO,CAAE,GAHM,CAFoB,CADvB,CAAlB,CAWA3E,EAAW,CAAClB,EAAZ,CAAe,iBAAf,CAAkC,UAAM,CACtC,GAAI+B,CAAAA,CAAW,CAAGb,EAAW,CAACC,WAAZ,EAAlB,CACA5C,EAAe,CAACI,WAAhB,CACEoD,CAAW,CAAG,GAAI1N,CAAAA,CAAE,CAAC4P,IAAH,CAAQC,KAAZ,CAAkBnC,CAAlB,CAAH,CAAoC,IADjD,EAIA,GAAIb,EAAW,CAAC9E,GAAZ,CAAgB,QAAhB,CAAJ,CAA+B,CAC7BgF,CAAM,CAAC5L,EAAD,CAAMuM,CAAN,CAAN,CACAb,EAAW,CAAC7C,aAAZ,CAA0B,CAAET,MAAM,GAAR,CAA1B,CACD,CAED,GAAIsD,EAAW,CAAC9E,GAAZ,CAAgB,mBAAhB,CAAJ,CAA0C,CACxCmD,CAAY,OAAZ,CACA2B,EAAW,CAAC7C,aAAZ,CAA0B,CAAEyH,iBAAiB,GAAnB,CAA1B,CACD,CAEF,CAhBD,EAiBA5E,EAAW,CAAClB,EAAZ,CAAe,yBAAf,CAA0C,UAAM,CAC9C7B,EAAe,CAACQ,WAAhB,CAA4BuC,EAAW,CAAC6E,mBAAZ,EAA5B,CAED,CAHD,EAIA,GAAIC,CAAAA,EAAiC,GAArC,CACA9E,EAAW,CAAClB,EAAZ,CAAe,OAAf,CAAwB,SAAAiG,CAAK,CAAI,CAE/B/E,EAAW,CAAC7C,aAAZ,CAA0B,CAAE6H,WAAW,GAAb,CAA1B,EACAnF,CAAK,CAACkF,CAAK,CAACE,OAAP,CAAL,CACA,GACEF,CAAK,CAACG,IAAN,EAAcH,CAAK,CAACI,iBAApB,EACAlR,CADA,EAEA,CAACL,CAFD,EAGA,IAAAkR,EAJF,CAKE,CACAM,UAAU,CAAC,UAAM,CACfnS,CAAC,CAAC,cAAD,CAAD,CAAkBoS,KAAlB,CAAwB,MAAxB,CAAgC,CAAEC,UAAU,CAAE,QAAd,CAAhC,EACAR,EAAiC,GAClC,CAHS,CAGP,GAHO,CAIX,CACF,CAfD,EAgBA9E,EAAW,CAACuF,WAAZ,CAAwBtR,CAAxB,EAEA4I,EAAM,CAACiC,EAAP,CAAU,QAAV,CAAoB,SAAAvB,CAAQ,CAAI,CAC9B,GAAiC,CAA7B,GAAAA,CAAQ,CAACiI,QAAT,CAAkBzQ,MAAtB,CAAoC,CAClC,GACEmD,CAAmB,CAAC6H,QAApB,GACExC,CAAQ,CAACiI,QAAT,CAAkB,CAAlB,EAAqBtK,GAArB,CAAyB,eAAzB,CADF,EAEAqC,CAAQ,CAACiI,QAAT,CAAkB,CAAlB,EAAqBtK,GAArB,CAAyB,gBAAzB,CAFA,EAGA,CAACxC,CAHD,EAIAC,CALF,CAME,CACA8M,CAAa,CAAC,YAAD,CAAb,CACAxS,CAAC,CAAC,sBAAD,CAAD,CAA0ByQ,QAA1B,CAAmC,MAAnC,CACD,CATD,IASO,IACDgC,CAAAA,CAAS,CAAGnI,CAAQ,CAACiI,QAAT,CAAkB,CAAlB,EAAqBtK,GAArB,CAAyB,MAAzB,CADX,CAEDyK,CAAS,CAAGpI,CAAQ,CAACiI,QAAT,CAAkB,CAAlB,EAAqBtK,GAArB,CAAyB,MAAzB,CAFX,CAGD0K,CAAI,CAAGrI,CAAQ,CAACiI,QAAT,CAAkB,CAAlB,EAAqBtK,GAArB,CAAyB,MAAzB,CAHN,CAML,GAAIqC,CAAQ,CAACiI,QAAT,CAAkB,CAAlB,EAAqBtK,GAArB,CAAyB,gBAAzB,CAAJ,CAAgD,CAC9C,GAAIwK,CAAS,EAAIC,CAAjB,CAA4B,CAI3B,CAGF,CAGD,GAAIC,CAAJ,CAAU,CAET,CAEF,CACF,CACF,CAlCD,EAmCAtR,EAAG,CAACwK,EAAJ,CAAO,OAAP,CAAgB,SAAA+G,CAAG,CAAI,CACrB,GAAIC,CAAAA,CAAU,GAAd,CACAxR,EAAG,CAACyR,qBAAJ,CACEzR,EAAG,CAAC0R,aAAJ,CAAkBH,CAAG,CAACI,aAAtB,CADF,CAEE,SAAAjL,CAAO,CAAI,CACT,GACmC,CAAjC,GAAAA,CAAO,CAACE,GAAR,CAAY,eAAZ,GACwB,eAAxB,GAAAF,CAAO,CAACE,GAAR,CAAY,MAAZ,CADA,EAEwB,eAAxB,GAAAF,CAAO,CAACE,GAAR,CAAY,MAAZ,CAHF,CAIE,CACA,QACD,CACD4K,CAAU,GACX,CAXH,EAaA,GAAIlS,CAAiB,EAAI,CAACkS,CAA1B,CAAsC,CACpC,GAAIjF,CAAAA,CAAW,CAAGvM,EAAG,CAAC4R,kBAAJ,CAAuBL,CAAG,CAACI,aAA3B,CAAlB,CACAzI,EAAa,CAACC,WAAd,CACEoD,CAAW,CAAG,GAAI1N,CAAAA,CAAE,CAAC4P,IAAH,CAAQC,KAAZ,CAAkBnC,CAAlB,CAAH,CAAoC,IADjD,CAGD,CACF,CArBD,EAsBA5N,CAAC,CAAC,cAAD,CAAD,CAAkB6L,EAAlB,CAAqB,OAArB,CAA8B,SAAAqH,CAAE,CAAI,CAElC,GAAItN,CAAJ,CAAoB,CAClBA,CAAc,CAACuN,KAAf,EACD,CACD,GAAItN,EAAJ,CAAc,CACZuN,YAAY,CAACvN,EAAD,CACb,CAPiC,GAQ5BwN,CAAAA,CAAgB,CAAGrT,CAAC,CAAC,iBAAD,CARQ,CAS5BsT,CAAK,CAAGJ,CAAE,CAACrI,MAAH,CAAUyI,KATU,CAWlCD,CAAgB,CAAC/C,IAAjB,CADW,EACX,EACA,GAAIgD,CAAK,EAAmB,CAAf,CAAAA,CAAK,CAACxR,MAAnB,CAA+B,CAM7B+D,EAAQ,CAAGsM,UAAU,CAAC,UAAM,CAC1BvM,CAAc,CAAGvF,CAAW,CAACkT,MAAZ,CAAmBD,CAAnB,EACd5R,IADc,CACT,SAAA8R,CAAI,CAAI,CACZ,GAAoB,CAAhB,GAAAA,CAAI,CAAC1R,MAAT,CAAuB,CACrBuR,CAAgB,CAAC/C,IAAjB,CACE,+BACE3O,CAAO,UADT,CAEE,OAHJ,CAKD,CAND,IAMO,CACL3B,CAAC,CAAC2Q,IAAF,CAAO6C,CAAP,CAAa,SAAC3R,CAAD,CAAI4R,CAAJ,CAAc,IACrBnI,CAAAA,CAAI,CAAGtL,CAAC,CAAC,UAAD,CAAa,CACvB8D,IAAI,CAAE,QADiB,CAEvByH,KAAK,CAAE,wCAFgB,CAAb,CAAD,CAIR0F,QAJQ,CAICoC,CAJD,EAKR7H,KALQ,CAKF,UAAM,CACX,GAAI9G,CAAAA,CAAM,CAAG,CACDgP,UAAU,CAACD,CAAK,CAACE,WAAN,CAAkB,CAAlB,CAAD,CADT,CAEDD,UAAU,CAACD,CAAK,CAACE,WAAN,CAAkB,CAAlB,CAAD,CAFT,CAGDD,UAAU,CAACD,CAAK,CAACE,WAAN,CAAkB,CAAlB,CAAD,CAHT,CAIDD,UAAU,CAACD,CAAK,CAACE,WAAN,CAAkB,CAAlB,CAAD,CAJT,CAAb,CAKAjP,CAAM,CAAGxE,CAAE,CAAC4C,IAAH,CAAQC,eAAR,CACP2B,CADO,CAEP,WAFO,CAGP,WAHO,CAAT,CAKAuI,CAAM,CAAC5L,EAAD,CAAM,IAAN,CAAYqD,CAAZ,CAAN,CACAkP,CAAc,CAAC,cAAD,CACf,CAlBQ,CADc,CAoBrBlI,CAAW,CAAG1L,CAAC,CAAC,OAAD,CAAU,CAC3B8F,IAAI,CAAE2N,CAAK,CAACI,YADe,CAE3BtI,KAAK,CAAE,eAFoB,CAAV,CAAD,CAGfK,MAHe,CAGR5L,CAAC,CAAC,wCAAD,CAHO,CApBO,CAwBzBsL,CAAI,CAACM,MAAL,CAAYF,CAAZ,CACD,CAzBD,CA0BD,CACF,CApCc,EAqCdkE,IArCc,CAqCT,UAAM,CAAE,CArCC,EAsCdkE,MAtCc,CAsCP,UAAM,CACZlO,CAAc,CAAG,IAClB,CAxCc,CAyClB,CA1CoB,CA0ClB,GA1CkB,CA2CtB,CACF,CA9DD,EAgEA5F,CAAC,CAAC+T,QAAD,CAAD,CAAYlI,EAAZ,CAAe,qBAAf,CAAsC,UAAM,CAC1C,GAAImI,CAAAA,CAAS,CAAGhU,CAAC,CAACiU,MAAD,CAAD,CAAUC,MAAV,GAAqB,GAArB,CAA2B,IAA3C,CACAlU,CAAC,CAAC,mCAAD,CAAD,CAAqC2P,GAArC,CAAyC,YAAzC,CAAuDqE,CAAvD,CACD,CAHD,EAKAhU,CAAC,CAAC+T,QAAD,CAAD,CAAYlI,EAAZ,CACE,iBADF,CAEE,8DAFF,CAGE,UAAW,CACT7L,CAAC,CAAC,IAAD,CAAD,CAAQmU,MAAR,GACAvK,EAAM,CAACiG,WAAP,GAAqBd,KAArB,EACD,CANH,EASA/O,CAAC,CAAC+T,QAAD,CAAD,CAAYlI,EAAZ,CAAe,OAAf,CAAwB,gBAAxB,CAA0C,UAAM,CAC9C1G,CAAQ,CAAG,EACZ,CAFD,EAIAnF,CAAC,CAACiU,MAAD,CAAD,CAAUpI,EAAV,CAAa,QAAb,CAAuB,UAAM,CAC3BxK,EAAG,CAAC+S,UAAJ,EACD,CAFD,EAIA,GAAIzR,CAAJ,CAAqB,CACnB3C,CAAC,CAAC,aAAD,CAAD,CAAiB6L,EAAjB,CAAoB,OAApB,CAA6B,UAAM,CACjC,GAAIkB,EAAW,CAAC9E,GAAZ,CAAgB,aAAhB,CAAJ,CAAoC,CAClCjI,CAAC,CAAC,cAAD,CAAD,CAAkBoS,KAAlB,CAAwB,MAAxB,CAAgC,CAAEC,UAAU,CAAE,QAAd,CAAhC,CACD,CAFD,IAEO,CACLxF,CAAa,IACd,CACF,CAND,CAOD,CACD7M,CAAC,CAAC,YAAD,CAAD,CAAgB6L,EAAhB,CAAmB,eAAnB,CAAoC,UAAM,CACxCjC,EAAM,CAACiG,WAAP,GAAqBd,KAArB,EACD,CAFD,EAIA/O,CAAC,CAAC,eAAD,CAAD,CAAmB6L,EAAnB,CAAsB,OAAtB,CAA+B,UAAM,CACnCa,CAAgB,IACjB,CAFD,EAGA1M,CAAC,CAAC,aAAD,CAAD,CAAiB6L,EAAjB,CAAoB,OAApB,CAA6B,SAAAwI,CAAK,CAAI,CAEpC,GAAI9B,CAAAA,CAAQ,CAAGvS,CAAC,CAAC,2CAAD,CAAhB,CACA,GAAI,CAAC0F,CAAL,CAAgB,CACd2O,CAAK,CAACC,cAAN,GACA1H,CAAK,CAACjL,CAAO,aAAR,CACN,CAHD,IAGO,CACL,GAAwB,CAApB,GAAA4Q,CAAQ,CAACzQ,MAAb,CAA2B,CACzBuS,CAAK,CAACC,cAAN,GACA1H,CAAK,CAACjL,CAAO,iBAAR,CACN,CAHD,IAGO,CACLyJ,CAAY,OAAemH,CAAQ,CAACgC,GAAT,EAAf,CACb,CACF,CACF,CAdD,EAeAvU,CAAC,CAAC,mBAAD,CAAD,CAAuB6L,EAAvB,CAA0B,OAA1B,CAAmC,SAAAwI,CAAK,CAAI,CAC1C,GAAI5O,CAAJ,CAAkB,CAChB4O,CAAK,CAACC,cAAN,GACA1H,CAAK,CAACjL,CAAO,cAAR,CAAL,CACA,MACD,CACD,GAAI,CAAC+D,CAAL,CAAgB,CACd2O,CAAK,CAACC,cAAN,GACA1H,CAAK,CAACjL,CAAO,aAAR,CAAL,CACA,MACD,CACD,GAAqC,EAAjC,GAAAsD,CAAmB,CAACiK,QAAxB,CAAyC,CACvCmF,CAAK,CAACC,cAAN,GACA1H,CAAK,CAACjL,CAAO,cAAR,CAAL,CACA6Q,CAAa,CAAC,YAAD,CAAb,CACA,MACD,CACD,GAAI,CAACvN,CAAmB,CAACkK,cAAzB,CAAyC,CACvCkF,CAAK,CAACC,cAAN,GACA1H,CAAK,CAACjL,CAAO,qBAAR,CAAL,CACA6Q,CAAa,CAAC,YAAD,CAEd,CACF,CAvBD,EA2BA,QAAS5F,CAAAA,CAAT,CAAe6C,CAAf,CAAoB,CAClB,GAAyB,CAArB,CAAAzP,CAAC,CAAC,QAAD,CAAD,CAAY8B,MAAhB,CAA4B,CAC1BqQ,UAAU,CAAC,UAAM,CACfvF,CAAK,CAAC6C,CAAD,CACN,CAFS,CAEP,IAFO,CAGX,CAJD,IAIO,CACLzP,CAAC,CACC,oEAEEyP,CAFF,CAGE,YAJH,CAAD,CAMGE,GANH,CAMO,CACH6E,IAAI,CAAE,CAACxU,CAAC,CAACiU,MAAD,CAAD,CAAUzN,KAAV,GAAoB,GAArB,EAA4B,CAD/B,CAEHiO,GAAG,CAAEzU,CAAC,CAACiU,MAAD,CAAD,CAAUC,MAAV,GAAqB,CAFvB,CANP,EAUGjD,QAVH,CAUYjR,CAAC,CAAC,gBAAD,CAVb,EAWG0U,KAXH,CAWS,GAXT,EAYGC,OAZH,CAYW,GAZX,CAYgB,UAAW,CACvB3U,CAAC,CAAC,IAAD,CAAD,CAAQmU,MAAR,EACD,CAdH,CAeD,CACF,CAoGD,QAAS3B,CAAAA,CAAT,CAAuB1B,CAAvB,CAA2B,CACzB9Q,CAAC,CAAC8Q,CAAD,CAAD,CAAM8D,QAAN,CAAe,QAAf,EACA5U,CAAC,CAAC,eAAD,CAAD,CAAmB4U,QAAnB,CAA4B,oBAA5B,CACD,CACD,QAAShB,CAAAA,CAAT,CAAwB9C,CAAxB,CAA4B,CAC1B9Q,CAAC,CAAC8Q,CAAD,CAAD,CAAM+D,WAAN,CAAkB,QAAlB,EACA7U,CAAC,CAAC,eAAD,CAAD,CAAmB6U,WAAnB,CAA+B,oBAA/B,CACD,CACD,QAASpS,CAAAA,CAAT,CAAoBqS,CAApB,CAA6B,CAC3B,GAAIA,CAAJ,CAAa,CACX9U,CAAC,CAAC,gBAAD,CAAD,CAAoB4U,QAApB,CAA6B,QAA7B,CACD,CAFD,IAEO,CACL5U,CAAC,CAAC,gBAAD,CAAD,CAAoB6U,WAApB,CAAgC,QAAhC,CACD,CACF,CACF,CACF,CAtwCK,CAAN","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module    mod_treasurehunt/play\n * @package   mod_treasurehunt\n * @copyright 2016 onwards Adrian Rodriguez Fernandez <huorwhisp@gmail.com>, Juan Pablo de Castro <jpdecastro@tel.uva.es>\n * @author Adrian Rodriguez <huorwhisp@gmail.com>\n * @author Juan Pablo de Castro <jpdecastro@tel.uva.es>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n  \"jquery\",\n  \"core/url\",\n  \"mod_treasurehunt/ol\",\n  \"core/ajax\",\n  \"mod_treasurehunt/geocoder\",\n  \"mod_treasurehunt/osm-geocoder\",\n  \"mod_treasurehunt/viewgpx\",\n  \"core/str\",\n  \"mod_treasurehunt/jquery.truncate\"\n  // \"mod_treasurehunt/jquery.mobile-config\",\n  // \"mod_treasurehunt/jquerymobile\"\n], function($, url, ol, ajax, GeocoderJS, OSMGeocoder, viewgpx, str) {\n  // console.log(\"loading play.js with jquery \" + $().jquery);\n  let init = {\n    playtreasurehunt: function(\n      cmid,\n      treasurehuntid,\n      playwithoutmoving,\n      groupmode,\n      lastattempttimestamp,\n      lastroadtimestamp,\n      gameupdatetime,\n      tracking,\n      user,\n      custommapconfig\n    ) {\n      // I18n strings.\n      let terms = [\n        \"stageovercome\",\n        \"failedlocation\",\n        \"stage\",\n        \"stagename\",\n        \"stageclue\",\n        \"question\",\n        \"noanswerselected\",\n        \"timeexceeded\",\n        \"searching\",\n        \"continue\",\n        \"noattempts\",\n        \"aerialview\",\n        \"roadview\",\n        \"noresults\",\n        \"startfromhere\",\n        \"nomarks\",\n        \"updates\",\n        \"activitytoendwarning\",\n        \"huntcompleted\",\n        \"discoveredlocation\",\n        \"answerwarning\",\n        \"error\"\n      ];\n      // console.log(\"loading i18n strings\");\n      let stringsqueried = terms.map(term => {\n        return { key: term, component: \"treasurehunt\" };\n      });\n      // i18n = i18nplay; // Use globally passed strings. Moodle 3.8 core/str broke with jquery 2.1.4.\n      str.get_strings(stringsqueried).done(strings => {\n        let i18n = [];\n        for (let i = 0; i < terms.length; i++) {\n          i18n[terms[i]] = strings[i]; // JPC: TODO: Global strings.\n        }\n        // i18n = i18nplay;\n        // Detect custom image.\n        if (\n          typeof custommapconfig != \"undefined\" &&\n          custommapconfig &&\n          custommapconfig.custombackgroundurl\n        ) {\n          // console.log(\"Detecting custom background image dimensions.\");\n          // Detect image size.\n          let img = new Image();\n          img.addEventListener(\"load\", function() {\n            custommapconfig.imgwidth = this.naturalWidth;\n            custommapconfig.imgheight = this.naturalHeight;\n            // console.log(\n            //   \"image is \" +\n            //     this.naturalWidth +\n            //     \"x\" +\n            //     this.naturalHeight +\n            //     \"pixels\"\n            // );\n            initplaytreasurehunt(\n              i18n,\n              cmid,\n              treasurehuntid,\n              playwithoutmoving,\n              groupmode,\n              lastattempttimestamp,\n              lastroadtimestamp,\n              gameupdatetime,\n              tracking,\n              user,\n              custommapconfig\n            );\n          });\n          img.src = custommapconfig.custombackgroundurl;\n        } else {\n          initplaytreasurehunt(\n            i18n,\n            cmid,\n            treasurehuntid,\n            playwithoutmoving,\n            groupmode,\n            lastattempttimestamp,\n            lastroadtimestamp,\n            gameupdatetime,\n            tracking,\n            user,\n            custommapconfig\n          );\n        }\n      });\n    } // End of function playtreasurehunt.\n  };\n  return init;\n  // Initialization function.\n  function initplaytreasurehunt(\n    strings,\n    cmid,\n    treasurehuntid,\n    playwithoutmoving,\n    groupmode,\n    lastattempttimestamp,\n    lastroadtimestamp,\n    gameupdatetime,\n    tracking,\n    user,\n    custommapconfig\n  ) {\n    // I18n support.\n    // console.log(\"init player Openlayers\");\n    // $.mobile.loading(\"show\");\n    setLoading(true);\n    let mapprojection = \"EPSG:3857\";\n    let custombaselayer = null;\n    let geographictools = true;\n    let defaultzoom = 15;\n    // Support customized base layers.\n    if (custommapconfig) {\n      if (custommapconfig.custombackgroundurl) {\n        // console.log(\"config custom background image\");\n        let customimageextent = ol.proj.transformExtent(\n          custommapconfig.bbox,\n          \"EPSG:4326\",\n          mapprojection\n        );\n        if (!custommapconfig.geographic) {\n          // Round bbox and scales to allow vectorial SVG rendering. (Maintain ratio.)\n          let bboxheight = customimageextent[3] - customimageextent[1];\n          let centerwidth = (customimageextent[2] + customimageextent[0]) / 2;\n          let centerheight = (customimageextent[3] + customimageextent[1]) / 2;\n          let ratiorealmap = Math.round(bboxheight / custommapconfig.imgheight);\n          let adjwidth = Math.round(custommapconfig.imgwidth * ratiorealmap);\n          let adjheight = Math.round(custommapconfig.imgheight * ratiorealmap);\n          customimageextent = [\n            centerwidth - adjwidth / 2,\n            centerheight - adjheight / 2,\n            centerwidth + adjwidth / 2,\n            centerheight + adjheight / 2\n          ];\n          defaultzoom = 5;\n        }\n        custombaselayer = new ol.layer.Image({\n          title: custommapconfig.layername,\n          name: custommapconfig.layername,\n          type: custommapconfig.layertype,\n          source: new ol.source.ImageStatic({\n            url: custommapconfig.custombackgroundurl,\n            imageExtent: customimageextent\n          }),\n          opacity: 1.0\n        });\n      } else if (custommapconfig.wmsurl) {\n        // console.log(\"config custom wms server: \" + custommapconfig.wmsurl);\n        let options = {\n          source: new ol.source.TileWMS({\n            url: custommapconfig.wmsurl,\n            params: custommapconfig.wmsparams\n          }),\n          type: custommapconfig.layertype,\n          title: custommapconfig.layername,\n          name: custommapconfig.layername\n        };\n        if (\n          custommapconfig.bbox[0] &&\n          custommapconfig.bbox[1] &&\n          custommapconfig.bbox[2] &&\n          custommapconfig.bbox[3]\n        ) {\n          let customwmsextent = ol.proj.transformExtent(\n            custommapconfig.bbox,\n            \"EPSG:4326\",\n            mapprojection\n          );\n          options.extent = customwmsextent;\n        }\n        custombaselayer = new ol.layer.Tile(options);\n      }\n\n      geographictools = custommapconfig.geographic;\n    }\n    if (geographictools === false) {\n      // console.log(\"geographic tools disabled\");\n      playwithoutmoving = true;\n      $(\"#autolocate\").hide();\n    }\n\n    let parchmenturl = url.imageUrl(\"success_mark\", \"treasurehunt\");\n    let failureurl = url.imageUrl(\"failure_mark\", \"treasurehunt\");\n    let markerurl = url.imageUrl(\"my_location\", \"treasurehunt\");\n    let lastsuccessfulstage = {};\n    let interval;\n    let infomsgs = [];\n    let attemptshistory = [];\n    let changesinattemptshistory = false;\n    let changesinlastsuccessfulstage = false;\n    let changesinquestionstage = false;\n    let fitmap = false;\n    let roadfinished = false;\n    let available = true;\n    let qoaremoved = false;\n    let osmGeocoderXHR;\n    let osmTimer = 0;\n    /*-------------------------------Styles-----------------------------------*/\n    let text = new ol.style.Text({\n      textAlign: \"center\",\n      scale: 1.3,\n      fill: new ol.style.Fill({\n        color: \"#ffffff\"\n      }),\n      stroke: new ol.style.Stroke({\n        color: \"#000000\",\n        width: 3.5\n      })\n    });\n    let selectText = new ol.style.Text({\n      textAlign: \"center\",\n      scale: 1.4,\n      fill: new ol.style.Fill({\n        color: \"#fff\"\n      }),\n      stroke: new ol.style.Stroke({\n        color: \"#0097a7\",\n        width: 3.5\n      })\n    });\n    let defaultstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.5,\n        src: parchmenturl\n      }),\n      text: text,\n      zIndex: \"Infinity\"\n    });\n    let failstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.5,\n        src: failureurl\n      }),\n      text: text,\n      zIndex: \"Infinity\"\n    });\n    let defaultSelectstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.75,\n        src: parchmenturl\n      }),\n      text: selectText,\n      zIndex: \"Infinity\"\n    });\n    let failSelectstageStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 1],\n        opacity: 1,\n        scale: 0.75,\n        src: failureurl\n      }),\n      text: selectText,\n      zIndex: \"Infinity\"\n    });\n    let positionFeatureStyle = new ol.style.Style({\n      image: new ol.style.Circle({\n        radius: 6,\n        fill: new ol.style.Fill({\n          color: [0, 0, 0, 1]\n        }),\n        stroke: new ol.style.Stroke({\n          color: [255, 255, 255, 1],\n          width: 2\n        })\n      })\n    });\n    let accuracyFeatureStyle = new ol.style.Style({\n      fill: new ol.style.Fill({\n        color: [255, 255, 255, 0.3]\n      }),\n      stroke: new ol.style.Stroke({\n        color: [0, 0, 0, 0.5],\n        width: 1\n      }),\n      zIndex: -1\n    });\n    let markerFeatureStyle = new ol.style.Style({\n      image: new ol.style.Icon({\n        anchor: [0.5, 0.9],\n        opacity: 1,\n        scale: 1,\n        src: markerurl\n      })\n    });\n    /*-------------------------------Layers-----------------------------------*/\n    let layers = [];\n    let geoJSONFormat = new ol.format.GeoJSON();\n    let source = new ol.source.Vector({\n      projection: \"EPSG:3857\"\n    });\n    let attemptslayer = new ol.layer.Vector({\n      source: source,\n      style: style_function\n    });\n    let aeriallayer = new ol.layer.Tile({\n      visible: false,\n      source: new ol.source.BingMaps({\n        key: \"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR\",\n        imagerySet: \"AerialWithLabels\",\n        maxZoom: 19\n        // Use maxZoom 19 to see stretched tiles instead of the BingMaps\n        // \"no photos at this zoom level\" tiles\n        // maxZoom: 19.\n      })\n    });\n    aeriallayer.set(\"name\", strings[\"aerialview\"]);\n    let roadlayer = new ol.layer.Tile({\n      source: new ol.source.OSM()\n    });\n    roadlayer.set(\"name\", strings[\"roadview\"]);\n\n    let layersbase = [];\n    let layersoverlay = [];\n    if (!custommapconfig || custommapconfig.onlybase === false) {\n      layersbase = [aeriallayer, roadlayer];\n    }\n    if (custombaselayer) {\n      if (custommapconfig.layertype != \"overlay\") {\n        layersbase.push(custombaselayer);\n      } else {\n        layersoverlay.push(custombaselayer);\n      }\n    }\n    let layergroup = new ol.layer.Group({ layers: layersbase });\n    // All layers hidden except last one.\n    let toplayer = null;\n    layergroup.getLayers().forEach(layer => {\n      layer.setVisible(false);\n      toplayer = layer;\n    });\n    toplayer.setVisible(true);\n\n    let view = new ol.View({\n      center: [0, 0],\n      zoom: 2,\n      minZoom: 2\n    });\n    let select = new ol.interaction.Select({\n      layers: [attemptslayer],\n      style: select_style_function,\n      filter: feature => {\n        if (feature.get(\"stageposition\") === 0) {\n          return false;\n        }\n        return true;\n      }\n    });\n    let accuracyFeature = new ol.Feature();\n    accuracyFeature.setProperties({ name: \"user_accuracy\" });\n    accuracyFeature.setStyle(accuracyFeatureStyle);\n    let positionFeature = new ol.Feature();\n    positionFeature.setProperties({ name: \"user_position\" });\n    positionFeature.setStyle(positionFeatureStyle);\n    let userPosition = new ol.layer.Vector({\n      source: new ol.source.Vector({\n        features: [accuracyFeature, positionFeature]\n      })\n    });\n    let markerFeature = new ol.Feature();\n    markerFeature.setGeometry(null);\n    markerFeature.setStyle(markerFeatureStyle);\n    let markerVector = new ol.layer.Vector({\n      source: new ol.source.Vector({\n        features: [markerFeature]\n      })\n    });\n    layers.push(layergroup);\n    layers = layers.concat(layersoverlay);\n    layers = layers.concat([attemptslayer, userPosition, markerVector]);\n    // New Custom zoom.\n    let zoom = new ol.control.Zoom({\n      target: \"navigation\",\n      className: \"custom-zoom\"\n    });\n    let map = new ol.Map({\n      layers: layers,\n      controls: [zoom], //ol.control.defaults({rotate: false, attribution: false}),\n      target: \"mapplay\",\n      view: view,\n      loadTilesWhileAnimating: true,\n      loadTilesWhileInteracting: true\n    });\n    map.addInteraction(select);\n    // It initializes the game.\n    renew_source(false, true);\n    // For the game is updated every gameupdatetime seconds.\n    interval = setInterval(() => {\n      renew_source(false, false);\n    }, gameupdatetime);\n    // Initialize the page layers.\n\n    add_layergroup_to_list(layergroup);\n    layersoverlay.forEach(overlay => {\n      add_layer_to_list(overlay);\n    });\n    if (tracking && user) {\n      let tracklayergroup = viewgpx.addgpxlayer(\n        map,\n        cmid,\n        treasurehuntid,\n        strings,\n        user,\n        \"trackgroup\"\n      );\n      tracklayergroup.set(\"name\", tracklayergroup.get(\"title\"));\n\n      let tracklayer = tracklayergroup.getLayers().item(0);\n      let htmltitle = tracklayer.get(\"title\"); // Has a picture and a link.\n      let plaintitle = htmltitle.substring(htmltitle.indexOf(\"</a>\") + 4);\n      tracklayer.set(\"name\", plaintitle);\n      tracklayer.setVisible(false);\n      add_layer_to_list(tracklayer);\n    }\n    /*-------------------------------Functions-----------------------------------*/\n    function style_function(feature) {\n      // Get the income level from the feature properties.\n      let stageposition = feature.get(\"stageposition\");\n      if (stageposition === 0) {\n        let fill = new ol.style.Fill({\n          color: \"rgba(255,255,255,0.4)\"\n        });\n        let stroke = new ol.style.Stroke({\n          color: \"#0097a7\",\n          width: 1.25\n        });\n        let styles = new ol.style.Style({\n          image: new ol.style.Circle({\n            fill: fill,\n            stroke: stroke,\n            radius: 5\n          }),\n          fill: fill,\n          stroke: stroke,\n          text: new ol.style.Text({\n            text: strings[\"startfromhere\"],\n            textAlign: \"center\",\n            fill: new ol.style.Fill({\n              color: \"rgb(255,255,255)\"\n            }),\n            stroke: new ol.style.Stroke({\n              color: \"#0097a7\",\n              width: 5\n            })\n          })\n        });\n        return [styles];\n      }\n      if (!feature.get(\"geometrysolved\")) {\n        // Don't change the scale with the map. This is confusing failstageStyle.getImage().setScale((view.getZoom() / 30));.\n        failstageStyle.getText().setText(\"\" + stageposition);\n        return [failstageStyle];\n      }\n      // Don't change the scale with the map. This is confusing  defaultstageStyle.getImage().setScale((view.getZoom() / 100));.\n      defaultstageStyle.getText().setText(\"\" + stageposition);\n      return [defaultstageStyle];\n    }\n    function select_style_function(feature) {\n      let stageposition = feature.get(\"stageposition\");\n      if (!feature.get(\"geometrysolved\")) {\n        failSelectstageStyle.getText().setText(\"\" + stageposition);\n        return [failSelectstageStyle];\n      }\n      defaultSelectstageStyle.getText().setText(\"\" + stageposition);\n      return [defaultSelectstageStyle];\n    }\n    function validateposition() {\n      if (playwithoutmoving && !markerFeature.getGeometry()) {\n        toast(strings[\"nomarks\"]);\n      } else {\n        renew_source(true, false);\n      }\n    }\n    function autocentermap() {\n      const position = geolocation.getPosition();\n      fly_to(map, position);\n    }\n    function fly_to(map, point, extent) {\n      let duration = 700;\n      let view = map.getView();\n      if (extent) {\n        view.fit(extent, {\n          duration: duration\n        });\n      } else {\n        view.animate({\n          zoom: defaultzoom,\n          center: point,\n          duration: duration\n        });\n      }\n    }\n    /**\n     * Updates the model of the game.\n     * Notifies a new location for validation or a new answer to a question.\n     * @param {boolean} location requests a location validation.\n     * @param {boolean} initialize\n     * @param {int} selectedanswerid submits an answer to a question\n     * @param {string} qrtext submits a text scanned from a QRCode\n     * @returns {undefined}\n     */\n    function renew_source(location, initialize, selectedanswerid, qrtext) {\n      // let position holds the potition to be evaluated. undef if no evaluation requested\n      let position;\n      let currentposition;\n      let coordinates;\n      let answerid;\n\n      if (playwithoutmoving) {\n        coordinates = markerFeature.getGeometry();\n      } else {\n        coordinates = positionFeature.getGeometry();\n      }\n      if (coordinates) {\n        currentposition = geoJSONFormat.writeGeometryObject(coordinates, {\n          dataProjection: \"EPSG:4326\",\n          featureProjection: \"EPSG:3857\"\n        });\n      }\n      if (selectedanswerid) {\n        // $.mobile.loading(\"show\");\n        setLoading(true);\n        answerid = selectedanswerid;\n      }\n      if (location) {\n        position = currentposition;\n        setLoading(true);\n\n        // $.mobile.loading(\"show\");\n      }\n      let geojson = ajax.call([\n        {\n          methodname: \"mod_treasurehunt_user_progress\",\n          args: {\n            userprogress: {\n              treasurehuntid: treasurehuntid,\n              attempttimestamp: lastattempttimestamp,\n              roadtimestamp: lastroadtimestamp,\n              playwithoutmoving: playwithoutmoving,\n              groupmode: groupmode,\n              initialize: initialize,\n              location: position,\n              currentposition:\n                tracking && !playwithoutmoving ? currentposition : undefined, // only for tracking in mobility.\n              selectedanswerid: answerid,\n              qoaremoved: qoaremoved,\n              qrtext: qrtext\n            }\n          }\n        }\n      ]);\n      geojson[0]\n        .done(response => {\n          // let body = \"\";\n          qoaremoved = response.qoaremoved;\n          roadfinished = response.roadfinished;\n          available = response.available;\n          setLoading(false);\n\n          // $.mobile.loading(\"hide\");\n          // If I have sent a location or an answer I print out whether it is correct or not.\n          if (location || selectedanswerid) {\n            if (response.status && available) {\n              // console.log(response.status.msg);\n            }\n          }\n          if (response.qrexpected) {\n            $(\"#validateqr\").show();\n          } else {\n            $(\"#validateqr\").hide();\n          }\n          // If you change the game mode (mobile or static).\n          if (playwithoutmoving != response.playwithoutmoving) {\n            playwithoutmoving = response.playwithoutmoving;\n            if (!playwithoutmoving) {\n              markerFeature.setGeometry(null);\n            }\n          }\n          // If change the group mode.\n          if (groupmode != response.groupmode) {\n            groupmode = response.groupmode;\n          }\n          if (\n            lastattempttimestamp !== response.attempttimestamp ||\n            lastroadtimestamp !== response.roadtimestamp ||\n            initialize ||\n            !available\n          ) {\n            lastattempttimestamp = response.attempttimestamp;\n            lastroadtimestamp = response.roadtimestamp;\n            if (response.attempthistory.length > 0) {\n              attemptshistory = response.attempthistory;\n              changesinattemptshistory = true;\n            }\n            // Compruebo si es distinto de null, lo que indica que se ha actualizado.\n            if (response.attempts || response.firststagegeom) {\n              source.clear();\n              if (response.firststagegeom) {\n                source.addFeatures(\n                  geoJSONFormat.readFeatures(response.firststagegeom, {\n                    dataProjection: \"EPSG:4326\",\n                    featureProjection: \"EPSG:3857\"\n                  })\n                );\n              }\n              if (response.attempts.features.length > 0) {\n                source.addFeatures(\n                  geoJSONFormat.readFeatures(response.attempts, {\n                    dataProjection: \"EPSG:4326\",\n                    featureProjection: \"EPSG:3857\"\n                  })\n                );\n              }\n            }\n            // Check if it exists, which indicates that it has been updated.\n            if (response.lastsuccessfulstage) {\n              lastsuccessfulstage = response.lastsuccessfulstage;\n              changesinlastsuccessfulstage = true;\n              // If the stage is not solved I will notify you that there are changes.\n              if (lastsuccessfulstage.question !== \"\") {\n                changesinquestionstage = true;\n                $(\"#validatelocation\").hide();\n                $(\"#question_button\").show();\n              } else if (!lastsuccessfulstage.activitysolved) {\n                $(\"#validatelocation\").hide();\n                $(\"#question_button\").show();\n              } else {\n                $(\"#validatelocation\").show();\n                $(\"#question_button\").hide();\n              }\n            }\n            // Check if it is the first geometry or it is being initialized and center the map.\n            if (response.firststagegeom || initialize) {\n              fitmap = true;\n            }\n\n            set_lastsuccessfulstage();\n            fit_map_to_source();\n            set_question();\n            set_attempts_history();\n          }\n          if (response.infomsg.length > 0) {\n            infomsgs.forEach(() => {\n              // body += \"<p>\" + msg + \"</p>\";\n            });\n            response.infomsg.forEach(msg => {\n              infomsgs.push(msg);\n              // body += \"<p>\" + msg + \"</p>\";\n            });\n            // create_popup(\"displayupdates\", strings[\"updates\"], body);\n          }\n          if (!roadfinished) {\n            $(\"#roadended\").hide();\n          }\n          if (roadfinished || !available) {\n            $(\"#validatelocation\").hide();\n            $(\"#question_button\").hide();\n            $(\"#roadended\").show();\n            markerFeature.setGeometry(null);\n            playwithoutmoving = false;\n            clearInterval(interval);\n            $(\"#mapplay\").css(\"opacity\", \"0.8\");\n          }\n        })\n        .fail(() => {\n          // console.log(error);\n          // create_popup(\"displayerror\", strings[\"error\"], error.message);\n          clearInterval(interval);\n        });\n    }\n    function fit_map_to_source() {\n      if (fitmap) {\n        let features = source.getFeatures();\n        if (\n          features.length === 1 &&\n          features[0].getGeometry() instanceof ol.geom.Point\n        ) {\n          fly_to(map, features[0].getGeometry().getCoordinates());\n        } else {\n          fly_to(map, null, source.getExtent());\n        }\n\n        fitmap = false;\n      }\n    }\n    function set_lastsuccessfulstage() {\n      if (changesinlastsuccessfulstage) {\n        $(\"#lastsuccessfulstagename\").text(\n          strings[\"stage\"] + \":\" + lastsuccessfulstage.name\n        );\n        $(\"#lastsuccesfulstagepos\").text(\n          lastsuccessfulstage.position + \" / \" + lastsuccessfulstage.totalnumber\n        );\n        let maxchars = 100;\n        let briefing;\n        // Clean color styles from clue.\n        lastsuccessfulstage.clue = lastsuccessfulstage.clue.replace(\n          /color/gm,\n          \"color-disabled\"\n        );\n        $(\"#lastsuccessfulstageclue\").html(lastsuccessfulstage.clue);\n        let clueplaintext = lastsuccessfulstage.clue.replace(\n          /<(?:.|\\n)*?>/gm,\n          \"\"\n        );\n        if (clueplaintext.length > maxchars * 2) {\n          $(\"#lastsuccessfulstageclue\").truncate(maxchars * 2);\n          briefing =\n            ' <a href=\"#historypage\" data-transition=\"none\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-icon-left ' +\n            'ui - btn - inline ui - icon - info ui - btn - icon - notext\"></a> ';\n          $(\"#lastsuccessfulstageclue\").append(briefing);\n        } else {\n          briefing = lastsuccessfulstage.clue;\n        }\n\n        $(\"#lastsuccessfulstagename2\").text(lastsuccessfulstage.name);\n        $(\"#lastsuccesfulstagepos2\").text(\n          lastsuccessfulstage.position + \" / \" + lastsuccessfulstage.totalnumber\n        );\n        $(\"#lastsuccessfulstageclue2\").html(lastsuccessfulstage.clue);\n\n        if (lastsuccessfulstage.question !== \"\") {\n          $(\"#lastsuccessfulstageclue\").append(\n            \"<a href='#questionpage' \" +\n              \"data-transition='none' class='ui-btn ui-shadow ui-corner-all \" +\n              \"ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>\" +\n              strings[\"question\"] +\n              \"</a>\"\n          );\n          $(\"#lastsuccessfulstageclue2\").append(\n            \"<a href='#questionpage' \" +\n              \"data-transition='none' class='ui-btn ui-shadow ui-corner-all \" +\n              \"ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>\" +\n              strings[\"question\"] +\n              \"</a>\"\n          );\n        }\n        // openSidePanel(\"#infopanel\");\n        $(\"#lastsuccessfulstage\").collapse(\"show\");\n        changesinlastsuccessfulstage = false;\n      }\n    }\n    function set_question() {\n      if (changesinquestionstage) {\n        // Clean color tag.\n        lastsuccessfulstage.question = lastsuccessfulstage.question.replace(\n          /color/gm,\n          \"color-disabled\"\n        );\n\n        $(\"#questionform\").html(\n          \"<legend>\" + lastsuccessfulstage.question + \"</legend>\"\n        );\n        let counter = 1;\n        $.each(lastsuccessfulstage.answers, (key, answer) => {\n          let id = \"answer\" + counter;\n          // Clean color tag.\n          answer.answertext = answer.answertext.replace(\n            /color/gm,\n            \"color-disabled\"\n          );\n\n          $(\"#questionform\").append(\n            '<input type=\"radio\" name=\"answers\" id=\"' +\n              id +\n              '\"value=\"' +\n              answer.id +\n              '\">' +\n              '<label for=\"' +\n              id +\n              '\">' +\n              answer.answertext +\n              \"</label>\"\n          );\n          counter++;\n        });\n\n        // $(\"#questionform\")\n        //   .html(questionform)\n        //   .scrollTop();\n        // // Enhance this with jquery mobile.\n        // // JPC: It doesn't work in some cases (i.e. Moodle 3.7) probably some interaction with jquery, jqueryui and jquerymobile.\n        // // When the radio controls are not correctly shown its better to show the native controls.\n        // $(\"#questionform\").enhanceWithin();\n        // setTimeout(\n        //   () =>\n        //     $(\"#questionform input\").removeClass(\"ui-helper-hidden-accessible\"),\n        //   1\n        // ); //.controlgroup(\"refresh\");\n        changesinquestionstage = false;\n      }\n    }\n    function set_attempts_history() {\n      // I'm checking to see if there have been any changes since the last time.\n      if (changesinattemptshistory) {\n        let $historylist = $(\"#historylist\"); // TODO: Why the variable starts with $?\n        // Lo reinicio\n        $historylist.html(\"\");\n        changesinattemptshistory = false;\n        if (attemptshistory.length === 0) {\n          $(\"<li>\" + strings[\"noattempts\"] + \"</li>\").appendTo($historylist);\n        } else {\n          // Anado cada intento\n          attemptshistory.forEach(attempt => {\n            $(\n              \"<li><span class='ui-btn-icon-left \" +\n                (attempt.penalty\n                  ? \"ui-icon-delete failedattempt\"\n                  : \"ui-icon-check successfulattempt\") +\n                \"' style='position:relative'></span>\" +\n                attempt.string +\n                \"</li>\"\n            ).appendTo($historylist);\n          });\n        }\n      }\n    }\n    function add_layer_to_list(layer) {\n      let link = $(\"<button>\", {\n        type: \"button\",\n        class: \"list-group-item list-group-item-action close-modal\"\n      }).click(() => {\n        layer.setVisible(!layer.getVisible());\n      });\n      let linkContent = $(\"<div>\", {\n        text: layer.get(\"name\"),\n        class: \"layer-item \" + (layer.getVisible() ? \"\" : \"unchecked\")\n      }).append($(\"<i class='fa fa-check-circle'>\"));\n      link.append(linkContent);\n      layer.on(\"change:visible\", () => {\n        $(linkContent).toggleClass(\"unchecked\");\n      });\n      $(\"#layerslist\").prepend(link);\n    }\n\n    function add_layergroup_to_list(layergroup) {\n      layergroup.getLayers().forEach(layer => {\n        let link = $(\"<button>\", {\n          type: \"button\",\n          class: \"list-group-item list-group-item-action close-modal\"\n        }).click(() => {\n          layergroup.getLayers().forEach(l => {\n            if (l === layer) {\n              l.setVisible(true);\n            } else {\n              l.setVisible(false);\n            }\n          });\n        });\n        let linkContent = $(\"<div>\", {\n          text: layer.get(\"name\"),\n          class: \"layer-item \" + (layer.getVisible() ? \"\" : \"unchecked\")\n        }).append($(\"<i class='fa fa-check-circle'>\"));\n        link.append(linkContent);\n        layer.on(\"change:visible\", () => {\n          $(linkContent).toggleClass(\"unchecked\");\n        });\n        $(\"#layerslist\").prepend(link);\n      });\n    }\n    /**\n     * Geolocation component\n     * @type ol.Geolocation\n     */\n    let geolocation = new ol.Geolocation(\n      /** @type {olx.GeolocationOptions} */ ({\n        projection: view.getProjection(),\n        trackingOptions: {\n          enableHighAccuracy: true,\n          maximumAge: 0,\n          timeout: 10000\n        }\n      })\n    );\n    /*-------------------------------Events-----------------------------------*/\n    geolocation.on(\"change:position\", () => {\n      let coordinates = geolocation.getPosition();\n      positionFeature.setGeometry(\n        coordinates ? new ol.geom.Point(coordinates) : null\n      );\n      // The map must be re-centered in the new position\n      if (geolocation.get(\"center\")) {\n        fly_to(map, coordinates);\n        geolocation.setProperties({ center: false }); // Disable center request. Deprecated.\n      }\n      // the new position must be evaluated\n      if (geolocation.get(\"validate_location\")) {\n        renew_source(true, false);\n        geolocation.setProperties({ validate_location: false }); // Disable validate_location request. Deprecated.\n      }\n      // $.mobile.loading(\"hide\");\n    });\n    geolocation.on(\"change:accuracyGeometry\", () => {\n      accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());\n      // $.mobile.loading(\"hide\");\n    });\n    let trackinggeolocationwarndispatched = false;\n    geolocation.on(\"error\", error => {\n      // $.mobile.loading(\"hide\");\n      geolocation.setProperties({ user_denied: true });\n      toast(error.message);\n      if (\n        error.code == error.PERMISSION_DENIED &&\n        tracking &&\n        !playwithoutmoving &&\n        trackinggeolocationwarndispatched == false\n      ) {\n        setTimeout(() => {\n          $(\"#popupgeoloc\").popup(\"open\", { positionTo: \"window\" });\n          trackinggeolocationwarndispatched = true;\n        }, 500);\n      }\n    });\n    geolocation.setTracking(tracking); // Start position tracking.\n\n    select.on(\"select\", features => {\n      if (features.selected.length === 1) {\n        if (\n          lastsuccessfulstage.position ===\n            features.selected[0].get(\"stageposition\") &&\n          features.selected[0].get(\"geometrysolved\") &&\n          !roadfinished &&\n          available\n        ) {\n          openSidePanel(\"#infopanel\");\n          $(\"#lastsuccessfulstage\").collapse(\"show\");\n        } else {\n          let stagename = features.selected[0].get(\"name\");\n          let stageclue = features.selected[0].get(\"clue\");\n          let info = features.selected[0].get(\"info\");\n          // let body = \"\";\n          // let title = \"\";\n          if (features.selected[0].get(\"geometrysolved\")) {\n            if (stagename && stageclue) {\n              // title = strings[\"stageovercome\"];\n              // body = get_block_text(strings[\"stagename\"], stagename);\n              // body += get_block_text(strings[\"stageclue\"], stageclue);\n            } else {\n              // title = strings[\"discoveredlocation\"];\n            }\n          } else {\n            // title = strings[\"failedlocation\"];\n          }\n          if (info) {\n            // body += \"<p>\" + info + \"</p>\";\n          }\n          // create_popup(\"infostage\", title, body);\n        }\n      }\n    });\n    map.on(\"click\", evt => {\n      let hasFeature = false;\n      map.forEachFeatureAtPixel(\n        map.getEventPixel(evt.originalEvent),\n        feature => {\n          if (\n            feature.get(\"stageposition\") === 0 ||\n            feature.get(\"name\") === \"user_position\" ||\n            feature.get(\"name\") === \"user_accuracy\"\n          ) {\n            return false;\n          }\n          hasFeature = true;\n        }\n      );\n      if (playwithoutmoving && !hasFeature) {\n        let coordinates = map.getEventCoordinate(evt.originalEvent);\n        markerFeature.setGeometry(\n          coordinates ? new ol.geom.Point(coordinates) : null\n        );\n      }\n    });\n    $(\"#searchInput\").on(\"input\", ev => {\n      // Abort xhr request if a new one arrives\n      if (osmGeocoderXHR) {\n        osmGeocoderXHR.abort();\n      }\n      if (osmTimer) {\n        clearTimeout(osmTimer);\n      }\n      const $searchContainer = $(\"#searchsResults\");\n      const value = ev.target.value;\n      let html = \"\";\n      $searchContainer.html(html);\n      if (value && value.length > 2) {\n        // $.mobile.loading(\"show\", {\n        //   text: strings[\"searching\"],\n        //   textVisible: true,\n        //   theme: \"b\"\n        // });\n        osmTimer = setTimeout(() => {\n          osmGeocoderXHR = OSMGeocoder.search(value)\n            .done(resp => {\n              if (resp.length === 0) {\n                $searchContainer.html(\n                  \"<li class='list-group-item'>\" +\n                    strings[\"noresults\"] +\n                    \"</li>\"\n                );\n              } else {\n                $.each(resp, (i, place) => {\n                  let link = $(\"<button>\", {\n                    type: \"button\",\n                    class: \"list-group-item list-group-item-action\"\n                  })\n                    .appendTo($searchContainer)\n                    .click(() => {\n                      let extent = [];\n                      extent[0] = parseFloat(place.boundingbox[2]);\n                      extent[1] = parseFloat(place.boundingbox[0]);\n                      extent[2] = parseFloat(place.boundingbox[3]);\n                      extent[3] = parseFloat(place.boundingbox[1]);\n                      extent = ol.proj.transformExtent(\n                        extent,\n                        \"EPSG:4326\",\n                        \"EPSG:3857\"\n                      );\n                      fly_to(map, null, extent);\n                      closeSidePanel(\"#searchpanel\");\n                    });\n                  let linkContent = $(\"<div>\", {\n                    text: place.display_name,\n                    class: \"search-option\"\n                  }).append($(\"<i class='fa fa-chevron-circle-right'>\"));\n                  link.append(linkContent);\n                });\n              }\n            })\n            .fail(() => {})\n            .always(() => {\n              osmGeocoderXHR = null;\n            });\n        }, 400);\n      }\n    });\n    // Set a max-height to make large images shrink to fit the screen.\n    $(document).on(\"popupbeforeposition\", () => {\n      let maxHeight = $(window).height() - 200 + \"px\";\n      $('.ui-popup [data-role=\"content\"]').css(\"max-height\", maxHeight);\n    });\n    // Remove the popup after it has been closed to manage DOM size.\n    $(document).on(\n      \"popupafterclose\",\n      \".ui-popup:not(#QRdialog):not(#popupdialog):not(#popupgeoloc)\",\n      function() {\n        $(this).remove();\n        select.getFeatures().clear();\n      }\n    );\n\n    $(document).on(\"click\", \"#acceptupdates\", () => {\n      infomsgs = [];\n    });\n    // Redraw map.\n    $(window).on(\"resize\", () => {\n      map.updateSize();\n    });\n    //Buttons events.\n    if (geographictools) {\n      $(\"#autolocate\").on(\"click\", () => {\n        if (geolocation.get(\"user_denied\")) {\n          $(\"#popupgeoloc\").popup(\"open\", { positionTo: \"window\" });\n        } else {\n          autocentermap(true);\n        }\n      });\n    }\n    $(\"#infopanel\").on(\"sidebar:close\", () => {\n      select.getFeatures().clear();\n    });\n\n    $(\"#sendLocation\").on(\"click\", () => {\n      validateposition(true);\n    });\n    $(\"#sendAnswer\").on(\"click\", event => {\n      // Selecciono la respuesta.\n      let selected = $(\"#questionform input[type='radio']:checked\");\n      if (!available) {\n        event.preventDefault();\n        toast(strings[\"timeexceeded\"]);\n      } else {\n        if (selected.length === 0) {\n          event.preventDefault();\n          toast(strings[\"noanswerselected\"]);\n        } else {\n          renew_source(false, false, selected.val());\n        }\n      }\n    });\n    $(\"#validatelocation\").on(\"click\", event => {\n      if (roadfinished) {\n        event.preventDefault();\n        toast(strings[\"huntcompleted\"]);\n        return;\n      }\n      if (!available) {\n        event.preventDefault();\n        toast(strings[\"timeexceeded\"]);\n        return;\n      }\n      if (lastsuccessfulstage.question !== \"\") {\n        event.preventDefault();\n        toast(strings[\"answerwarning\"]);\n        openSidePanel(\"#infopanel\");\n        return;\n      }\n      if (!lastsuccessfulstage.activitysolved) {\n        event.preventDefault();\n        toast(strings[\"activitytoendwarning\"]);\n        openSidePanel(\"#infopanel\");\n        return;\n      }\n    });\n    /*-------------------------------Initialize page -------------*/\n\n    /*-------------------------------Help functions -------------*/\n    function toast(msg) {\n      if ($(\".toast\").length > 0) {\n        setTimeout(() => {\n          toast(msg);\n        }, 2500);\n      } else {\n        $(\n          \"<div class='ui-loader ui-overlay-shadow  ui-corner-all toast'>\" +\n            \"<p>\" +\n            msg +\n            \"</p></div>\"\n        )\n          .css({\n            left: ($(window).width() - 284) / 2,\n            top: $(window).height() / 2\n          })\n          .appendTo($(\"play-container\"))\n          .delay(2000)\n          .fadeOut(400, function() {\n            $(this).remove();\n          });\n      }\n    }\n    // function create_popup(type, title, body) {\n    //   let header = $('<div data-role=\"header\"><h2>' + title + \"</h2></div>\"),\n    //     content = $(\n    //       '<div data-role=\"content\" class=\"ui-content ui-overlay-b\">' +\n    //         body +\n    //         \"</div>\"\n    //     ),\n    //     popup = $(\n    //       '<div data-role=\"popup\" id=\"' +\n    //         type +\n    //         '\"' +\n    //         'data-theme=\"b\" data-transition=\"slidedown\"></div>'\n    //     );\n    //   if (type === \"infostage\") {\n    //     $(\n    //       '<a href=\"#\" data-rel=\"back\" class=\"ui-btn ui-corner-all' +\n    //         'ui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right\"></a>'\n    //     ).appendTo(header);\n    //   }\n    //   if (type === \"displayupdates\") {\n    //     $(\n    //       '<p class=\"center-wrapper\"><a id=\"acceptupdates\" href=\"#\" data-rel=\"back\"' +\n    //         'class=\"ui-btn center-button ui-mini ui-btn-inline\">' +\n    //         strings[\"continue\"] +\n    //         \"</a></p>\"\n    //     ).appendTo(content);\n    //     let attributes = {\n    //       \"data-dismissible\": false,\n    //       \"data-overlay-theme\": \"b\"\n    //     };\n    //     $(popup).attr(attributes);\n    //   }\n    //   if (type === \"displayerror\") {\n    //     $(\n    //       '<p class=\"center-wrapper\"><a href=\"view.php?id=' +\n    //         cmid +\n    //         '\" class=\"ui-btn  center-button ui-mini ui-icon-forward ui-btn-inline ui-btn-icon-left\"' +\n    //         'data-ajax=\"false\">' +\n    //         strings[\"continue\"] +\n    //         \"</a></p>\"\n    //     ).appendTo(content);\n    //     let attributes = {\n    //       \"data-dismissible\": false,\n    //       \"data-overlay-theme\": \"b\"\n    //     };\n    //     $(popup).attr(attributes);\n    //   }\n    //   // Create the popup.\n    //   $(header)\n    //     .appendTo(\n    //       $(popup)\n    //         .appendTo($.mobile.activePage)\n    //         .popup()\n    //     )\n    //     .toolbar()\n    //     .after(content);\n    //   // Need it for calculate popup's dimesions when popup contents an image.\n    //   totalimg = $(content).find(\"img\");\n    //   if (totalimg.length > 0) {\n    //     // $.mobile.loading(\"show\");\n    //     totalimg.one(\"load\", function() {\n    //       imgloaded++;\n    //       if (totalimg.length === imgloaded) {\n    //         open_popup(popup);\n    //         imgloaded = 0;\n    //         // Clear the fallback\n    //         clearTimeout(fallback);\n    //         // $.mobile.loading(\"hide\");\n    //       }\n    //     });\n    //     // Fallback in case the browser doesn't fire a load event.\n    //     let fallback = setTimeout(function() {\n    //       open_popup(popup);\n    //       // $.mobile.loading(\"hide\");\n    //     }, 2000);\n    //   } else {\n    //     open_popup(popup);\n    //   }\n    // }\n    // function open_popup(popup) {\n    //   // Because chaining of popups not allowed in jquery mobile.\n    //   if ($(\".ui-popup-active\").length > 0) {\n    //     $(\".ui-popup\").popup(\"close\");\n    //     setTimeout(function() {\n    //       $(popup).popup(\"open\", { positionTo: \"window\" });\n    //     }, 1000);\n    //   } else {\n    //     $(popup).popup(\"open\", { positionTo: \"window\" });\n    //   }\n    // }\n    // function get_block_text(title, body) {\n    //   return (\n    //     '<div class=\"ui-bar ui-bar-a\">' +\n    //     title +\n    //     '</div><div class=\"ui-body ui-body-a\">' +\n    //     body +\n    //     \"</div>\"\n    //   );\n    // }\n    function openSidePanel(id) {\n      $(id).addClass(\"active\");\n      $(\".sidebar-mask\").addClass(\"active dismissible\");\n    }\n    function closeSidePanel(id) {\n      $(id).removeClass(\"active\");\n      $(\".sidebar-mask\").removeClass(\"active dismissible\");\n    }\n    function setLoading(loading) {\n      if (loading) {\n        $(\".global-loader\").addClass(\"active\");\n      } else {\n        $(\".global-loader\").removeClass(\"active\");\n      }\n    }\n  }\n});\n"],"file":"play.min.js"}